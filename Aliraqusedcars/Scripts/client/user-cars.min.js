$("body").addClass("boxed");var saveDataSucc=function(n){n=n.d;n&&n>0&&($("#lnkApproveNotif").addClass("hidden"),$(".modal").modal("hide"),showMessage("تم تأكيد الإلغاء","تم تأكيد إلغاء الفواتير بنجاح. شكرا لك."))},startApproveCancelation=function(){var n=$("#myCancelledInv .modal-body strong.invNo").map(function(){return $(this).text()}).get().join(",");n&&dataService.callAjax("Post",JSON.stringify({ids:n}),"mypaidcars.aspx/saveClientApprove",saveDataSucc,errorException)},getPageAlerts=function(){dataService.callAjax("Post",{},"myfinishedcars.aspx/GetDataDirect",bingData,errorException)},bingData=function(n){var u=comp2json(n.d),i=u.list,t,r;i&&(t="#myCancelledInv",r=$(i).map(function(n,t){return'<div class="alert alert-danger"><p>تم إلغاء فاتورة مبيعات رقم: <strong class="invNo">'+t.SaleInvoiceID+"<\/strong> وذلك بسبب/ <strong>"+t.DeleteReason+"<\/strong><\/p><\/div>"}).get(),$(t).find("div.modal-body").prepend(r),$("#lnkApproveNotif").removeClass("hidden"),$(t).modal("show"))},comp2json=function(n){var t=LZString.decompressFromUTF16(n),i=$.parseXML(t);return $.xml2json(i)},aarrivedCar=function(n){return n.Arrived==="true"||n.WithoutShipping==="true"},filllistItems=function(){var n=$(".totalRequired"),i=$(".debit"),t;n.text(0);t=$("#listItems").DataTable({sDom:"<'row'<'col-sm-6'l><'col-sm-6'BTf>r>t<'row'<'col-sm-6'i><'col-sm-6'p>>",language:{url:"/Scripts/datatable/Arabic.min.js"},responsive:!0,buttons:[{extend:"csv",text:"تصدير إكسيل"},{text:"طباعة",action:function(){window.print()}}],bServerSide:!0,fixedHeader:!0,bRetrieve:!1,bDestroy:!0,sAjaxSource:sURL+"LoadCars?finish=0",fnServerData:function(t,r,u){dataService.callAjax("GET",r,t,function(t){var s=comp2json(t.d),h=s.list,f=s.list1,e=s.list2,c,l,o;f=f?$.map(f,function(n){return n}):[0];c=$.isArray(h)?h:$.makeArray(h);l={sEcho:r.sEcho?r.sEcho:0,iTotalRecords:f[0],iTotalDisplayRecords:f[0],aaData:c};u(l);$(".clientName").html(e.full_name);n.text(numeral(e.PresentRequired).format("0,0"));o=e.BalanceDebit*1-e.BalanceCredit*1;i.text(numeral(o).format("0,0"));$(".clear").text(numeral(e.PresentRequired*1-o).format("0,0"));$("#listItems strong.pay").each(function(){$(this).text()*1>o*1&&$(this).replaceWith('<strong data-rel="tooltip" title="الرصيد لا يكفى لسداد المبلغ">'+numeral($(this).html()).format("0,0")+"<\/strong>")});updatableEvents()},errorException)},iDisplayLength:50,aaSorting:[],aoColumns:[{mData:"CarID",bSortable:!1,render:function(n,t,i){return'<a title="طباعة الفاتورة" target="_blank" href="/InvoicePrint.aspx?id='+i.SaleInvoiceID+'">'+n+"<\/a>"}},{mDataProp:"MainPicture",bSortable:!1,render:function(n,t,i){return i.MainPicture!==null?'<a target="_blank" data-rel="tooltip" title="سيارة رقم: '+i.CarID+'" href="/car/'+(i.CarID+"-"+i.MakerNameAr+"-"+i.TypeNameAr+"-"+i.Year).replace(/[_\W]+/g,"-")+'"><img alt="car" width="60" src="/public/cars/'+i.CarID+"/_thumb/"+i.MainPicture+'" /><\/a>':'<a href="/car/'+i.CarID+"-"+i.MakerNameAr+"-"+i.TypeNameAr+"-"+i.Year+'"><img alt="car" width="60" src="/public/cars/noimage.gif" /><\/a>'}},{mDataProp:"ChassisNo",bSortable:!1,render:function(n,t,i){return'<a target="_blank" data-rel="tooltip" class="model" title="عرض تفاصيل السيارة" title="عرض تفاصيل السيارة" href="/car/'+(i.CarID+"-"+i.MakerNameAr+"-"+i.TypeNameAr+"-"+i.Year).replace(/[_\W]+/g,"-")+'">'+i.MakerNameAr+" - "+i.TypeNameAr+" - "+i.Year+(i.PayInvTypeID==3?" - Relist":"")+'<\/a>                            <span title="الشاصي">'+i.ChassisNo+'<\/span>                            <span title="اللوت">اللوت:'+i.LotNo+"<\/span>"}},{mDataProp:"SalePrice",bSortable:!1,mData:function(n){return'<span class="red" data-rel="tooltip" title="سعر الشراء:  '+n.PayPrice+"$  -  عمولة الشركة: "+(n.SalePrice-n.PayPrice)+'$">'+numeral(n.SalePrice).format("0,0")+"<\/span>"}},{mDataProp:"CarRetainer",bSortable:!1,render:function(n,t,i){return i.CarRetainer*1>0?i.CarRetainerDone*1>0?'<s class="text-danger" data-rel="tooltip" title="تم السداد">'+numeral(i.CarRetainer).format("0,0")+"<\/s>":!aarrivedCar(i)&&i.SalePriceDemand==="true"&&i.SaleTypeID>1?'<strong data-rel="tooltip" class="text-fade" title="غير مفعل : السيارة غير واصه">'+numeral(i.CarRetainer).format("0,0")+"<\/strong>":'<strong data-rel="tooltip" class="text-black pay" title="المبلغ جاهز للسداد الآن">'+numeral(i.CarRetainer).format("0,0")+"<\/strong>":""}},{mData:null,bSortable:!1,render:function(n,t,i){return i.DelayedAfterDisc*1>0?i.CarDelayedDone*1>0?'<s class="text-danger" data-rel="tooltip"  title="تم السداد">'+numeral(i.DelayedAfterDisc).format("0,0")+"<\/s>":!aarrivedCar(i)&&(i.SalePriceDemand!="true"||i.SaleTypeID>1)?'<strong class="text-fade" title="غير مفعل : السيارة غير واصله">'+numeral(i.DelayedAfterDisc).format("0,0")+"<\/strong>":'<strong class="text-black" title="المبلغ جاهز للسداد الآن">'+numeral(i.DelayedAfterDisc).format("0,0")+"<\/strong>":""}},{mDataProp:"TotalCarShippExpenses",bSortable:!1,render:function(n,t,i){return i.TotalCarShippExpenses!==null?i.TotalCarShippExpensesDone*1>0?'<s class="text-danger" data-rel="tooltip"  title="تم السداد">'+numeral(i.TotalCarShippExpenses).format("0,0")+"<\/s>":'<strong class="text-black" title="المبلغ جاهز للسداد الآن">'+numeral(i.TotalCarShippExpenses).format("0,0")+"<\/strong>":"---"}},{mDataProp:"TotalCarShopExpenses",bSortable:!1,render:function(n,t,i){return i.TotalCarShopExpenses!==null?i.TotalCarShopExpensesDone*1>0?'<s class="text-danger" data-rel="tooltip"  title="تم السداد">'+numeral(i.TotalCarShopExpenses).format("0,0")+"<\/s>":'<strong class="text-black" data-rel="tooltip" title="المبلغ جاهز للسداد الآن">'+numeral(i.TotalCarShopExpenses).format("0,0")+"<\/strong>":"---"}},{mDataProp:"VAT",bSortable:!1,mData:function(n){if(n.VAT&&n.VAT*1>0){if(n.VATDone*1>0)return'<s class="red ace-tooltip" data-rel="tooltip" title="تم السداد">'+numeral(n.VAT).format("0,0")+"<\/s> "+undoLink;var i=n.CarRetainerDone*1>0&&n.CarDelayedDone*1>0&&n.TotalCarShippExpensesDone*1>0&&n.TotalCarShopExpensesDone*1>0&&n.ClientExtraOnCarPaid*1>0,t=' <a data-rel="tooltip" data-carid="'+n.CarID+'" data-vatvalue="'+n.VAT+'" title="إلغاء VAT عن العميل" href="javascript:void(0);" class="cancel-vat"><i class="icon-remove orange bigger-120"><\/i><\/a>';return i?'<strong class="text-black" title="المبلغ جاهز للسداد الآن">'+numeral(n.VAT).format("0,0")+"<\/strong>"+t:'<strong data-rel="tooltip" class="text-fade" title="غير مفعل للسداد إلا بعد سداد كل المطلوب على السيارة أولاً.">'+numeral(n.VAT).format("0,0")+"<\/strong>"+t}return"---"}},{mData:null,bSortable:!1,render:function(n,t,i){var u=addition(i.CarRetainer,i.TotalCarShippExpenses,i.TotalCarShopExpenses),e=(i.VAT||0)*1,o=i.Arrived==="true"||i.WithoutShipping==="true",r;i.Arrived==="true"&&(r=getNumbersFromString(i.CarDelayed),r=r==0?i.CarDelayed:r,u+=parseFloat(r)+parseFloat(e)-parseFloat(i.CarDiscount));var s=i.CarRetainerDone*1+i.CarDelayedDone*1+i.TotalCarShippExpensesDone*1+i.TotalCarShopExpensesDone*1+i.VATDone*1,h=u-s,c=i.ClientDiscountOnCar*1>0?'<i data-carid="'+i.CarID+'" title="خصم: '+numeral(i.ClientDiscountOnCar).format("0,0")+'" data-rel="tooltip" data-type="-1" class="addionalAmount text-success fa fa-smile-o fa-2x"><\/i>':"",f='<i data-carid="'+i.CarID+'" title="زيادة: '+(i.ClientExtraOnCar*1>0?numeral(i.ClientExtraOnCar).format("0,0"):numeral(i.ClientExtraOnCarPaid).format("0,0"))+'" data-rel="tooltip" data-type="1" class="addionalAmount text-danger fa fa-frown-o fa-2x"><\/i> ',l=i.ClientExtraOnCar*1>0?f+(i.SaleTypeID==1||o||i.SalePriceDemand!="true"?'<a href="javascript:void(0);" class="pay payExtra inline" data-rel="tooltip" title="سداد مبلغ الزيادة"><strong class="text-black">'+numeral(i.ClientExtraOnCar).format("0,0")+"<\/strong><\/a>":""):"",a=i.ClientExtraOnCar*1<=0&&i.ClientExtraOnCarPaid*1>0?f+'<s data-rel="tooltip" title="تم السداد"  class="red ace-tooltip inline">'+numeral(i.ClientExtraOnCarPaid).format("0,0")+"<\/s>":l;return'<strong class="carRequired" title="المطلوب على السيارة">'+numeral(h).format("0,0")+"<\/strong> &nbsp;"+c+" "+a}},{bSortable:!1,mData:function(n){return n.Arrived==="true"?'<img src="/App_Themes/iraq/images/'+n.DistinationNameEn+'.jpg" width="25" /> '+n.DistinationNameAr:'<img src="/App_Themes/iraq/images/USA.jpg" width="25" /> أمريكا '+(n.ShipCompanyNameEn?n.ShipCompanyNameEn.split("-")[1]:"")}},{mData:null,bSortable:!1,sClass:"hidden-print",render:function(n,t,i){return'<a target="_blank" title="عرض السيارة بالموقع" href="mycarsetforsale?id='+i.CarID+'"><i class="fa fa-eye fa-2x"><\/i><\/a>'}}]});searchDataTables(t);$(document).delegate("#listItems tbody tr i.addionalAmount","click",function(n){n.preventDefault();var t=$(this),u=t.attr("data-type")*1>0?"Extras":"Discounts",i=t.attr("data-carid"),r="تفاصيل مبلغ الـ"+t.attr("data-original-title")+" $",f=function(n){var i=commonManger.comp2json(n.d),r=i.list,t=0,u=$(r).map(function(n,i){return t+=parseFloat(i.ExtraAmount*1),"<tr><td>"+i.MakerNameEn+" - "+i.TypeNameEn+" - "+i.Year+"<\/td><td>"+numeral(i.ExtraAmount?i.ExtraAmount:i.DiscountAmount).format("0,0")+"<\/td><td>"+moment(i.AddDate).format("YYYY/MM/DD")+"<\/td><td>"+i.Notes+"<\/td><\/tr>"}).get();$("#lists tbody").html("").append(u);$(".total").text(t.toFixed())};i!==null&&(dto={actionName:"Client"+u+"_One",value:i},dataService.callAjax("Post",JSON.stringify(dto),sURL+"GetData",f,commonManger.errorException),$(".addtionalAmountTitle").text(r),$(".addtionalAmountDetails").text(r),$("#myAddionalAmounts").modal("show"))})},updatableEvents=function(){$('[data-toggle="tooltip"],[data-rel=tooltip],.ace-tooltip').tooltip();$(document).on("mouseleave",'[data-toggle="tooltip"],[data-rel=tooltip],.ace-tooltip',function(){$(this).tooltip("hide");$(".tooltip.fade.in").remove()})};filllistItems();getPageAlerts();$(".modal-footer .approveBtn").click(function(n){n.preventDefault();startApproveCancelation()});