var payInvoicePayment=function(){var c=$("#AuctionID"),f=$("#BuyerID").eq(0),o=$("#detailsForm #LotNo"),s=$("#detailsForm2 #LotNo"),l={local:4},a=3.674,n=$("#listItems").DataTable({sDom:"<'row'>t<'row'>",searching:!1,retrieve:!0,paging:!1,sort:!1}),t=$("#listItems2").DataTable({sDom:"<'row'>t<'row'>",searching:!1,retrieve:!0,paging:!1,sort:!1,columnDefs:[{targets:[1],visible:!1}]}),v=function(n){var t=!0;return $("#"+n+" .required").each(function(){$(this).val()===""&&(t=!1)}),$("#Amount").val()*1<=0&&(t=!1),t},y=function(n){n=n.d;n.Status?(commonManger.showMessage("",n.message),window.location.href="payinvoicepaymentsprint.aspx?id="+n.ID):(commonManger.disableControl("SaveAll",!1),commonManger.showMessage("خطأ بالحفظ:",n.message))},r=function(){var n={invTotal:numeral().unformat($(".invoicesFooter").text()),storageTotal:numeral().unformat($(".storageFooter").text()),latTotal:numeral().unformat($(".latFooter").text()),buyerFee:numeral().unformat($("#BuyerAnnualFee").val()),rate:$("#Rate").val()*1,auctionID:$("#AuctionID").val()*1,Convertamount:$("#Convertamount").val()*1},t,i;n.rate=n.rate>0?n.rate:a;$(".subFinesFooter").text(n.storageTotal+n.latTotal);t=n.invTotal+n.storageTotal+n.latTotal+n.buyerFee;i=t*n.rate+(n.auctionID===l.local?0:n.Convertamount);$("#TotalAmount,#Amount").val(t);$("#lblInvoiceTotal").text(numeral(t).format("0,0.0"));$("#AmountDhs").val(i.toFixed(3))},i=function(){var n=0;$("#listItems tbody").find("tr").find("td:nth-child(4)").each(function(){n+=numeral().unformat($(this).text())});$(".invoicesFooter").text(numeral(n).format("0,0.0"));r()},u=function(){var n=0,t=0;$("#listItems2 tbody").find("tr").each(function(){var i=numeral().unformat($(this).find("td:nth-child(3)").text()),r=numeral().unformat($(this).find("td:nth-child(4)").text());n+=i;t+=r});$(".latFooter").text(numeral(t).format("0,0.0"));$(".storageFooter").text(numeral(n).format("0,0.0"));r()},p=function(){$(".chzn-select").chosen({allow_single_deselect:!0,no_results_text:"اختـــر",search_contains:!1}).trigger("chosen:updated").trigger("liszt:updated")},e=function(n){n==="detailsForm"?($("#detailsForm #LotNo").val("").trigger("chosen:updated").trigger("liszt:updated"),$("#detailsForm  #ChassisNo").val(""),$("#PayPrice").val(0)):n==="detailsForm2"&&($("#detailsForm2 #LotNo").val("").trigger("chosen:updated").trigger("liszt:updated"),$("#detailsForm2 #ChassisNo").val(""),$("#Storge,#LatPayment,#detailsForm2 #CarID").val(0),$(":checkbox").attr("checked",!1))},w=function(n){var t=JSON.parse(n.d);$("#BuyerID, #detailsForm #LotNo, #detailsForm2 #LotNo").empty().append($("<option />"));$.each(t,function(n,t){t.tbl_name===0&&f.append("<option value='"+t.ID+"'>"+t.Name+"<\/option>")});f.trigger("chosen:updated").trigger("liszt:updated")},b=function(t){var r=commonManger.comp2json(t.d),u=r.list,f=r.list1;u&&(n.clear(),$(u).each(function(t,i){var r=[i.LotNo,i.ChassisNo,i.CarID,i.PayPrice,'<button class="btn btn-minier remove" data-rel="tooltip" data-placement="top" data-original-title="حــذف"><i class="icon-remove"><\/i><\/button>'];n.row.add(r).draw()}),i())},k=function(n){n!=""?(functionName="PayInvoicePayments_PropertiesFilter",DTO={actionName:functionName,value:n},dataService.callAjax("Post",JSON.stringify(DTO),mainServiceUrl+"GetData",w,commonManger.errorException)):$("#BuyerID,#detailsForm #LotNo,#detailsForm2 #LotNo").empty().append("<option><\/option>").chosen().trigger("chosen:updated").trigger("liszt:updated")},d=function(n){n!==""?(functionName="PayInvoicePayments_PropertiesCarsAvailable",DTO={actionName:functionName,value:n},dataService.callAjax("Post",JSON.stringify(DTO),sUrl+"GetData",b,commonManger.errorException)):$("#BuyerID, #detailsForm #LotNo,#detailsForm2 #LotNo").empty().append("<option><\/option>").chosen().trigger("chosen:updated").trigger("liszt:updated")},g=function(){tt();var n=decodeURIComponent(commonManger.getUrlVars().id);n&&n!=="undefined"?$("#PayInvoicePaymentsID").val(n):($("#VAT").val("2.5000"),ut());it()},nt=function(n,t,i,r,u,f,e,o){var s=[],h=[],c=commonManger.Returncontrolsval(n),l;h=c[0];s=c[1];l={values:s,actionName:e,Parm_names:h,fieldsDetails:i,valuesDetails:r,fieldsDetails2:u,valuesDetails2:f,flage:o};dataService.callAjax("Post",JSON.stringify(l),"PayInvoicePaymentDetails.aspx/SaveDataMasterDetails",t,commonManger.errorException)},tt=function(){$(".ace-switch-6").click(function(){$(this).prop("checked")?$("#LatPayment").val(50):$("#LatPayment").val(0)});$.fn.afterLoadDatawithdata=function(n){var t=$("#BuyerID option[value="+n.BuyerID+"]").val();t>0||($("#BuyerID").append('<option value="'+n.BuyerID+'">'+n.BuyerName+"<\/option>"),$("#BuyerID").val(n.BuyerID),$("#BuyerID").chosen().trigger("chosen:updated").trigger("liszt:updated"))};$.fn.aftersave=function(n){window.location.href="payinvoicepaymentsprint.aspx?id="+n.ID};$("#SaveAll").click(function(n){var r;if(n.preventDefault(),commonManger.disableControl("SaveAll",!0),r=v("aspnetForm"),r){var e=commonManger.returnFiledsNamesToSave("detailsForm"),i="",o=0,u=[];$("#listItems tbody").find("tr").each(function(){$(this).hasClass("row_neglict")||($(this).find("td").each(function(){i+=$(this).find("span").hasClass("label-success")?"true,":$(this).find("span").hasClass("label-danger")?"false,":$(this).text()+","}),i.toLowerCase().indexOf(",")>=0&&(i=i.substring(0,i.length-1)),i.toLowerCase().indexOf("عفواً")>=0&&(i="0,,0,0"),u.push(i),i="",o++)});var f=[],s=t.rows().data();$(s).each(function(n,t){var i=t[0]+","+t[1]+","+t[3]+","+t[4];f.push(i)});nt("aspnetForm",y,e,u,["LotNo","CarID","Storge","LatPayment"],f,"PayInvoicePayments_Save","1")}else commonManger.disableControl("SaveAll",!1),commonManger.showMessage("حقول مطلوبة:","<p>- برجاء التأكد من مطابقة إجمالى الفواتير مع إجمالى الحوالة $ <\/p><p>- برجاء ادخال جميع الحقول الاجبارية ذات العلامة (*)<\/p>")});$("#Convertamount").on("change",function(){r()});o.on("change",function(){if($(this).val()!==""){var n={value:$(this).val()};dataService.callAjax("Post",JSON.stringify(n),"PayInvoicePaymentDetails.aspx/GetCaresDate",function(n){var t=JSON.parse(n.d);$.each(t,function(n,t){$("#detailsForm #ChassisNo").val(t.ChassisNo);$("#detailsForm #CarID").val(t.CarID);$("#detailsForm #PayPrice").val(t.PayPrice)})},commonManger.errorException)}else commonManger.ResetControls("detailsForm")});s.on("change",function(){if($(this).val()!==""){var n={value:$(this).val()};dataService.callAjax("Post",JSON.stringify(n),"PayInvoicePaymentDetails.aspx/GetCaresDate",function(n){var t=JSON.parse(n.d);$.each(t,function(n,t){$("#detailsForm2 #ChassisNo").val(t.ChassisNo);$("#detailsForm2 #CarID").val(t.CarID)})},commonManger.errorException)}else e("detailsForm2")});$("#Savetemp").on("click",function(t){var c,a,h,s,u,f,r,l;if(t.preventDefault(),c=o.val(),a=$("#AmountToCheck").val(),c!==""){for(h=0,s=n.table().node(),r=0;r<s.length;r++)$(s[r]).hasClass("row_selected")&&($(s[r]).addClass("row_neglict"),$(s[r]).hide());for(u=[],f=[],u=commonManger.returnFiledsNames("detailsForm"),$("#listItems tbody").find("tr").find("td:nth-child(1)").each(function(){$(this).text()==$("#"+u[0]).val()&&(h=1)}),r=0;r<u.length;r++)u[r].substring(0,4)=="hide"?f.push("<td>hide"+$("#"+u[r]).val()+"<\/td>"):(l=$("#"+u[r]).prop("type"),l=="checkbox"?$("#"+u[r]).prop("checked",function(n,t){t==!0?f.push('<td><span class="label label-success"><i class="icon icon-check"><\/i><\/span><\/td>'):t==!1&&f.push('<td><span class="label label-danger"><i class="icon icon-remove"><\/i><\/span><\/td>')}):f.push("<td>"+$("#"+u[r]).val()+"<\/td>"));f.push('<button class="btn btn-minier remove" data-rel="tooltip" data-placement="top" data-original-title="حــذف"><i class="icon-remove"><\/i><\/button>');h!==1?(n.row.add(f).draw(!1),commonManger.showMessage("تمت الاضافة:","تم اضافة السيارة بنجاح.")):commonManger.showMessage("السيارة موجودة من قبل:","السيارة التى تود اضافتها موجود بالفعل بالحواله، يمكنك حذف السيارة واعادة اضافتها من جديد.");e("detailsForm");i()}else commonManger.showMessage("بيانات مطلوبة:","برجاء التأكد من إجمالى الفواتير واختيار رقم اللوت للسيارة أولاً."),$("#AmountToCheck").focus()});$("#Savetemp2").on("click",function(n){var o,c,r;if(n.preventDefault(),o=s.val(),c=$("#AmountToCheck").val(),o!==""){var h=0,i=[],f=[];if(i=["LotNo","CarID","ChassisNo","Storge","LatPayment"],$("#"+i[3]).val()!==""&&$("#"+i[4]).val()!==""&&($("#"+i[3]).val()!=="0"||$("#"+i[4]).val()!=="0")){for($("#listItems2 tbody").find("tr").find("td:nth-child(1)").each(function(){$(this).text()===$("#detailsForm2 #"+i[0]).val()&&(h=1)}),r=0;r<i.length;r++)i[r].substring(0,4)==="CarID"?f.push($("#detailsForm2 #"+i[r]).val()):f.push($("#detailsForm2 #"+i[r]).val());f.push('<button class="btn btn-minier remove" data-rel="tooltip" data-placement="top" data-original-title="حــذف"><i class="icon-remove"><\/i><\/button>');h!==1?(t.row.add(f).draw(!1),commonManger.showMessage("تمت الاضافة:","تم اضافة الغرامه بنجاح.")):commonManger.showMessage("السيارة موجودة من قبل:","الغرامع على السيارة التى تود اضافتها موجود بالفعل بالحواله، يمكنك حذف الغرامه/السيارة واعادة اضافتها من جديد.");e("detailsForm2");u()}else commonManger.showMessage("بيانات مطلوبة:","برجاء التأكد من إدخال مبلغ الغرامه.")}else commonManger.showMessage("بيانات مطلوبة:","برجاء التأكد من إجمالى الفواتير واختيار رقم اللوت للسيارة أولاً."),$("#AmountToCheck").focus()});c.change(function(){k($(this).val())});f.change(function(){n.clear().draw();t.clear().draw();d($(this).val())});$("#listItems tbody").delegate("tr button.remove","click",function(t){t.preventDefault();var u=$(this),r=u.closest("tr");r!=null&&DeleteConfirmation(function(){n.row(r).remove();n.draw();i()})});$("#listItems2 tbody").delegate("tr button.remove","click",function(n){n.preventDefault();var r=$(this),i=r.closest("tr");i!==null&&DeleteConfirmation(function(){t.row(i).remove();t.draw();u()})});$("#BuyerAnnualFee").on("keyup",function(){r()});$("#BuyerAnnualFee, #BuyerID").on("change blur",function(){var t;$(".mesg").html("");var n={buyer:$("#BuyerID").val(),fee:$("#BuyerAnnualFee").val()?$("#BuyerAnnualFee").val()*1:0},i=function(n,t){commonManger.showMessage(n,t);$(".mesg").html('<div class="alert alert-block alert-warning"><strong>'+n+"<\/strong> "+t+"<\/div>")},r=function(n){var o=commonManger.comp2json(n.d),u=o.list;if(u){var f=commonManger.formatJSONDateCal(new Date).split("/"),s=f[0]*1,h=f[2]*1-1,c=commonManger.formatJSONDateCal(u.PaymentsDates),e=c.split("/"),t=e[0]*1,r=e[2]*1;s===t&&h===r||i("تنبيه بعدم دفع رسوم الباير السنوى:","تم دفع آخر رسوم الباير السنوية فى: "+t+"-"+r+" ، ومطلوبه فى شهر: "+t+"-"+(r+1)+"")}};n.fee>0&&(t={actionName:"BuyerAnnual_FeeCheck",value:n.buyer},dataService.callAjax("Post",JSON.stringify(t),sUrl+"GetData",r,commonManger.errorException))});$("#Rate").change(function(){i();u()})},it=function(){var n=$("#PayInvoicePaymentsID").val(),t={actionName:"PayInvoicePayments_PropertiesDetails",value:n};dataService.callAjax("Post",JSON.stringify(t),sUrl+"GetData",rt,commonManger.errorException)},rt=function(r){var f=commonManger.comp2json(r.d),e=f.list,o=f.list1,s=f.list2,c=f.list3,a=$("#PayInvoicePaymentsID").val(),l;e&&($.each(e,function(n,t){var i,r;console.log(n,t);$("#"+n).val(t);i=$("#"+n);i.prop("type")!=="select-one"||i.hasClass("noreset")||(r=$("<option />").val(t).text(n=="BuyerID"?e.BuyerName:e.AuctionNameAr).attr("selected",!0),i.append(r),i.prop("disabled",!0).trigger("liszt:updated"))}),$(".date-picker").val(function(){var n=$(this).val();return moment().format("DD/MM/YYYY",n)}),$(".money").val(function(){var n=$(this).val();return numeral(n).format("0.00")}));o&&(h(o,"detailsForm",n),i());s&&(h(s,"detailsForm2",t),u());a==0&&c&&(l=$(c).map(function(n,t){return $("<option />").val(t.AuctionID).text(t.AuctionNameAr)}).get(),$("#AuctionID").append(l));p()},h=function(n,t,i){var r=commonManger.returnFiledsNames(t);n=$.isArray(n)?n:$.makeArray(n);$.each(n,function(n,t){for(var f,u=[],n=0;n<r.length;n++)f=r[n],$("#"+f).hasClass("money")?u.push(numeral(t[f]).format("0.00")):u.push(t[f]);u.push('<button class="btn btn-minier remove" data-rel="tooltip" data-placement="top" data-original-title="حــذف"><i class="icon-remove"><\/i><\/button>');i.row.add(u).draw()})},ut=function(){var n=function(n){var t=JSON.parse(n.d);$.each(t,function(n,t){$("#Convertamount").val(t.Convertamount)})};dataService.callAjax("Post",JSON.stringify({value:""}),mainServiceUrl+"GetConvetAmount",n,commonManger.errorException)};return{Init:g}}();payInvoicePayment.Init();