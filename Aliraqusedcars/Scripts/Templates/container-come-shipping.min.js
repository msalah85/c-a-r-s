$.fn.editable.defaults.mode="popup";var CarsLateShipping=function(){var i="",r="",n=commonManger.getQueryStrs().all,u=function(){if(n>0){var t="اقتراب وصول حاويات";$("li.active,.page-header h1").text(t);document.title=t}c();f();a()},f=function(){$("#carArrive .modal-footer button.btn-success").live("click",function(n){n.preventDefault();$(this).prop("disabled",!0).addClass("disabled");e()});$("#printedModal .modal-footer button.btn-success").live("click",function(n){n.preventDefault();s()});$("#downloadMeModal .modal-footer button.btn-success").live("click",function(n){n.preventDefault();h()});$("#btnSearchAll").click(function(n){n.preventDefault();i=$("#Shipper").val();r=$("#Distin").val();t()});$(".test").click(function(){$("#listItems .bol-cell").each(function(n,t){var i=$(t),r;return console.log(i.text()),i.text()==="958979529"?(i.closest("tr").find("td:eq(5)").text("Mohamed Salah"),r=i.closest("tr").find("td:eq(5)").text(),console.log(r),!1):void 0})})},e=function(){var n=$("#No").val(),i=$("#Bol").val(),r=$("#Type").val(),u=$("#ArrivalDate").val(),f=commonManger.dateFormat(u),e=function(n){n=n.d;r==="0"?$("#listItems .bol-cell").each(function(n,t){var r=$(t),f;if(r.text()===i)return f=r.closest("tr"),$(".recent-saved").removeClass("recent-saved"),f.find("td:eq(5)").text(u).addClass("recent-saved"),!1}):t();$("#carArrive").modal("hide");commonManger.showMessage("تم بنجاح:","تم تنفيذ الإجراء بنجاح")};if(n!==""){var o=[n,r,f,i],s={actionName:"CarsData_SetArrivalCarContainer",names:["no","type","date","Bol"],values:o};dataService.callAjax("Post",JSON.stringify(s),sUrl+"GetDataList",e,commonManger.errorException)}else $("#carArrive").modal("hide"),commonManger.showMessage("خطأ بالحفظ:","لم يتم حفظ تاريخ الوصول.");$("button.disabled").prop("disabled",!1).removeClass("disabled")},t=function(){var n=$("#listItems").DataTable();n.draw(!1)},o=function(n){n=n.d;n.Status?(t(),$(".modal").modal("hide"),commonManger.showMessage("تم بنجاح:","تم اعتماد طباعة الفاتورة.")):($("#printedModal").modal("hide"),commonManger.showMessage("خطأ بالحفظ:","لم يتم اعتماد طباعة الفاتورة."))},s=function(){var n=$("#InvoiceID").val(),t;n!==""?(t={actionName:"ContainerToCom_PrintInvoice",names:["id"],values:[n]},dataService.callAjax("Post",JSON.stringify(t),sUrl+"saveData",o,commonManger.errorException)):($("#printedModal").modal("hide"),commonManger.showMessage("خطأ بالحفظ:","لم يتم اعتماد طباعة الفاتورة."))},h=function(){var n=$("#InvID").val(),i=$('input[name="DownloadContainer"]:checked').val()||"",r,u;n!==""&&i!==""?(r={actionName:"Container_DownloadMe",names:["id","DownloadContainer"],values:[n,i]},u=function(n){n=n.d;n.Status?(t(),$(".modal").modal("hide"),commonManger.showMessage("تم بنجاح:","تم اعتماد تنزيل الحاوية فى مقر الشركة.")):($(".modal").modal("hide"),commonManger.showMessage("خطأ بالحفظ:","لم يتم اعتماد تنزيل الحاوية."))},dataService.callAjax("Post",JSON.stringify(r),sUrl+"saveData",u,commonManger.errorException)):commonManger.showMessage("خطأ بالحفظ:","لم يتم اعتماد تنزيل الحاوية.")},c=function(){n=n>0?n:"0";var t=$("#listItems").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BTf>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{extend:"copy",text:"نسـخ"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],language:{url:"/Scripts/datatable/Arabic.min.js",search:"_INPUT_",searchPlaceholder:"بحث برقم الحاوية - BOL"},bServerSide:!0,ordering:!1,bRetrieve:!1,bDestroy:!0,orderCellsTop:!0,rowsGroup:[6,0,4,5,7],sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(t){t.push({name:"funName",value:"Containers_SelectListToCome"},{name:"names",value:"NeerPort~Shipper~Distin"},{name:"values",value:n+"~"+i+"~"+r})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){var f=commonManger.comp2json(n.d),u=f.list,r=f.list1,e={sEcho:t.sEcho?t.sEcho:0,iTotalRecords:r?r.CNT:0,iTotalDisplayRecords:r?r.CNT:0,aaData:$.isArray(u)?u:$.makeArray(u)};i(e);r&&$(".allContainersCount").text(r.ContCount)},commonManger.errorException)},iDisplayLength:50,fnFooterCallback:function(){var i=this.api(),n=null,t=0;console.log("footer...");i.column(6,{page:"current"}).data().each(function(i){n!==i&&(n=i,t++)});$(".containersNum").text(t)},drawCallback:function(){var t=this.api(),r=t.rows({page:"current"}).nodes(),u=$("#listItems thead").html(),i=0,n="";t.rows().every(function(t){var u=this.data();n!==""&&u.ContainerNo!==n&&$(r).eq(i).addClass("groupSeparator");n=u.ContainerNo;i=t;$(".downloadme-flag").closest("tr").addClass("downloadme-flag-tr")});$("a.editable").editable({emptytext:"+ ملاحظة",validate:function(n){if($.trim(n)==="")return"مطلوب."},url:function(n){return n.table=$(this).data("table"),n.id=$(this).data("id"),$.ajax({type:"POST",url:sUrl+"InlineEdit",data:JSON.stringify(n),contentType:"application/json; charset=utf-8",dataType:"json",async:!0,cache:!1,timeout:1e4,success:function(){commonManger.showMessage("تم الحفظ:","تم حفظ الملاحظه بنجاح.")},error:function(){commonManger.showMessage("خطأ:","لقد حدث خطأ فى تنفيذ الإجراء.")}})},display:function(n){n&&$(this).html('<i class="icon-warning-sign orange"><\/i>')}})},aoColumns:[{bSortable:!1,mData:function(n){return n.ShipCompanyNameEn+'<a class="hidden-print pull-left" href="javascript:printSaleCarsBill.printBolCars(\''+n.Bol+'\');" title="طباعة فواتير البيع للسيارات بالحاوية"><i class="icon-print bigger-150"><\/i><\/a>'},sClass:"v-middle"},{bSortable:!1,mData:function(n){return`<a href="CarDetailsPrint.aspx?id=${n.CarID}" class="" data-rel="tooltip" title="وصول السيارة">${n.MakerNameEn}-${n.TypeNameEn}-${n.Year}</a>`}},{mDataProp:"full_name",bSortable:!1},{mDataProp:"LotNo",bSortable:!1},{bSortable:!1,sClass:"v-middle text-center",mData:"DistinationNameEn"},{bSortable:!1,sClass:"v-middle text-center",mData:function(n){return commonManger.formatJSONDateCal(n.ArrivalDate)}},{bSortable:!1,sClass:"v-middle",mData:function(n){return(n.InvoicePrinted==="false"?n.ContainerNo+'<a class="btn btn-mini hidden-print printMe" title="اعتمد طباعة الفاتورة الآن" data-id="'+n.ShippInvoiceID+'" href="#printedModal"><i class="icon-print"><\/i><\/a>':'<span title="تمت طباعة الفاتورة" class="red">'+n.ContainerNo+"<\/span>"+(n.InvoiceNo?"":' <a title="انشاء فاتورة شحن" href="InvoiceShippingAdd.aspx?id='+n.ShippInvoiceID+'">+فاتورة<\/a>'))+' <p title="شركة الملاحة">'+(n.NavigationCoName?n.NavigationCoName:"")+"<\/p>"}},{mDataProp:"Bol",sClass:"v-middle",bSortable:!0,mData:function(n){var t='<a title="اضف ملاحظة على الحاوية" data-placement="right" data-type="textarea" data-id="ShippInvoiceID" data-pk="'+n.ShippInvoiceID+'" data-table="ShippInvoices" data-name="ContainersNotes" class="editable tooltip-warning" href="#" data-placeholder="اضافة ملاحظه">'+(n.ContainersNotes?n.ContainersNotes:"")+"<\/a>";return'<div class="pull-left options hidden-print"><a href="javascript:void(0);" class="btn btn-minier btn-grey change-date" data-rel="tooltip" data-placement="top" title="تعديل تاريخ الوصول">تعديل تاريخ الوصول<\/a>'+(n.Arrived==="true"?'<a href="javascript:void(0);" class="btn btn-minier btn-danger download-me'+(n.DownloadMe==="true"?" downloadme-flag":"")+'" data-id="'+n.ShippInvoiceID+'" data-rel="tooltip" data-placement="top" title="تنــــــــــزيل الحــــــــاوية؟">تنـــــــزيل الحــــــــاوية؟<\/a>':"")+'<a href="javascript:void(0);" class="btn btn-minier btn-success container-come" data-rel="tooltip" data-placement="top" title="توصيل الحاوية">توصيــــل الحـاوية <i class="icon-anchor"><\/i><\/a> '+t+'<\/div><div class="bol-cell">'+n.Bol+"<\/div>"}}]});$("#listItems tbody").delegate("tr a.change-date","click",function(n){var u,r,i;if(n.preventDefault(),u=$(this),r=u.closest("tr"),r!==null){i=t.row(r).data();var f=i.ContainerNo,e=i.Bol,o="تاريخ وصول الحاوية رقم: "+f;$("#ArrivalDate").val(commonManger.formatJSONDateCal(i.ArrivalDate));$("#No").val(f);$("#Bol").val(e);$("#Type").val(0);$("#aspnetForm .alert").text("برجاء تأكيد تغيير تاريخ وصول الحاوية.");$("#carArrive .btn-success").text("تغيير تاريخ الوصول");commonManger.showPopUpDialog(o,"insert","carArrive")}});$("#listItems tbody").delegate("tr a.container-come","click",function(n){var u,i,r;if(n.preventDefault(),u=$(this),i=u.closest("tr"),i!==null){r=t.row(i).data();var f=r.ContainerNo,e=r.Bol,o="توصيل الحاوية رقم: "+f;$("#ArrivalDate").val(commonManger.formatJSONDateCal(new Date));$("#No").val(f);$("#Bol").val(e);$("#Type").val(1);$("#aspnetForm .alert").text("برجاء تأكيد توصيل الحاوية.");$("#carArrive .btn-success").text("توصيل الحاوية");commonManger.showPopUpDialog(o,"insert","carArrive")}});$("#listItems tbody").delegate("tr a.printMe","click",function(n){var i,r,u;if(n.preventDefault(),i=$(this),r=i.closest("tr"),r!==null){u=t.row(r).data();var f=u.ContainerNo;$("#InvoiceID").val(i.attr("data-id"));$("#containerNoo").text(f);commonManger.showPopUpDialog("طباعة الفاتورة: ","insert","printedModal")}});$("#listItems tbody").delegate("tr a.download-me","click",function(n){var i,r,u;if(n.preventDefault(),i=$(this),r=i.closest("tr"),r!==null){u=t.row(r).data();var f=u.ContainerNo;$("#InvID").val(i.attr("data-id"));$("#contNo").text(f);commonManger.showPopUpDialog("تنزيل/تفريغ الحاوية: ","insert","downloadMeModal")}})},l=function(n){var e=LZString.decompressFromUTF16(n.d),t=$.parseXML(e),i=$.xml2json(t).list2,r=$.xml2json(t).list1,u,f;i&&(u=$(i).map(function(n,t){return $("<option />").val(t.ShipMainCompanyID).text(t.ShipMainCompanyNameAr)}).get(),$("#Shipper").append(u));r&&(f=$(r).map(function(n,t){return $("<option />").val(t.DistinationID).text(t.DistinationNameAr)}).get(),$("#Distin").append(f));$(".chzn-select").trigger("chosen:updated").trigger("liszt:updated")},a=function(){dataService.callAjax("Post",JSON.stringify({actionName:"ShippInvoices_Properties"}),sUrl+"GetDataDirect",l,commonManger.errorException)},y=function(n){var o=commonManger.comp2json(n),t=o.list,r,i,u,f,e;if(t&&(t=$.isArray(t)?t:$.makeArray(t),t[0].phone)){for(r=[],i=0;i<t.length;i++)u={message:"وصول سيارة "+t[i].TypeNameEn+"-"+t[i].Year+" رقم "+t[i].CarID+" "+t[i].ColorNameAr,phones:((t[i].phone&&t[i].countryCode?t[i].countryCode+t[i].phone+",":"")+(t[i].phone2&&t[i].countryCode2?t[i].countryCode2+t[i].phone2:"")).replace(/,(\s+)?$/,"")},r.push(u.phones+"|"+u.message+"|"+t[i].full_name);f="sms-templates.aspx/BulkSMS";e={messages:r};dataService.callAjax("Post",JSON.stringify(e),f,v,commonManger.errorException)}},v=function(n){var t,i,r;for(n=n.d,t="",i=0;i<n.length;i++)r=n[i].split("|"),t+=r[0].indexOf("Successful")>0?"<p>تم ارسال رسالة لجوال العميل: "+r[1]+"<\/p>":"<p>لم ترسل رسالة لجوال العميل: "+r[1]+"<\/p>";t!==""&&commonManger.showMessage("تم توصيل الحاوية بنجاح:",t)};return{Init:u}}();