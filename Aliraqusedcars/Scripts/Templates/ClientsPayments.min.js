var cid="",ClientsPayments=ClientsPayments||{},ClientsPayments=function(){var i=function(){cid=commonManger.getUrlVars().id;cid=cid?cid:"";n();r();f()},r=function(){$("#cancelModal .modal-footer .btn-danger").on("click",function(n){var t,i;if(n.preventDefault(),t=$("#ClientPaymentID").val(),i=$("#DeleteReason").val(),t&&i!==""){var r=[t,i],f={actionName:"ClientsPayments_Delete",names:["ClientPaymentsID","DeleteReason"],values:r};dataService.callAjax("Post",JSON.stringify(f),sUrl+"saveData",u,commonManger.errorException)}else commonManger.showMessage("حقول مطلوبة","يرجي ادخال سبب الإلغاء أولاً."),$("#DeleteReason").focus()});$(".moneyBackClk").click(function(){var n=$("#listItems3 tbody tr").length;(!n||n<1)&&o();$("#paymentTabs li:last a").tab("show")});$(".discounts").click(function(){var n=$("#listItems2 tbody tr").length;(!n||n<1)&&e();$("#paymentTabs li:eq(1) a").tab("show")});$(".clientBonusClk").click(function(){var n=$("#listItems4 tbody tr").length;(!n||n<1)&&s();$("#paymentTabs li:eq(2) a").tab("show")});$(".clPaymentClc").click(function(){var n=$("#listItems tbody tr").length;(!n||n<1)&&fillListItems();$("#paymentTabs li:first a").tab("show")});$("#cancelBonus .modal-footer .btn-danger").on("click",function(t){t.preventDefault();var i=$("#BonusID").val(),r=$("#Reason").val(),u=function(t){t=t.d;$(".modal").modal("hide");commonManger.showMessage("تم تنفيذ الإجراء بنجاح.",t.message);t.Status&&($("#listItems4").DataTable().draw(),n())};if(i&&r!==""){var f=[i,r],e={actionName:"ClientsBonus_Delete",names:["BonusID","Reason"],values:f};dataService.callAjax("Post",JSON.stringify(e),sUrl+"saveData",u,commonManger.errorException)}else commonManger.showMessage("حقول مطلوبة","يرجي ادخال سبب الإلغاء أولاً."),$("#DeleteReason").focus()})},u=function(n){n=n.d;$(".modal").modal("hide");commonManger.showMessage("تم تنفيذ الإجراء بنجاح.",n.message);n.Status&&$("#listItems").DataTable().draw()},n=function(){var n={actionName:"ClientsPayments_Summary",value:cid?cid:""},t=function(n){var i=commonManger.comp2json(n.d),t=i.list;$(".debit").text(numeral(t.Payments).format("0,0"));$(".moneyBacks").text(numeral(t.MoneyBack).format("0,0"));$(".totalDiscounts").text(numeral(t.Discounts).format("0,0"));$(".clientBonus").text(numeral(t.Bonus).format("0,0"));$(".balance").text(numeral(t.Balance).format("0,0"));$(".clientName").text(t.ClientName)};cid&&($(".clientName").attr("href","ClientCars.aspx?id="+cid),$(".add-disount").removeClass("hidden").attr("href","ClientDiscounts.aspx?id="+cid),$(".addPay").removeClass("hidden").attr("href","ClientsPaymentsAdd.aspx?cid="+cid));dataService.callAjax("Post",JSON.stringify(n),sUrl+"GetData",t,commonManger.errorException)},t=function(){var n=commonManger.fullRoles();return n?'<button class="btn btn-mini btn-danger remove" data-rel="tooltip" data-placement="top" data-original-title="حــذف"><i class="icon-remove"><\/i><\/button>':""},h=function(n){n&&($(".totalDiscounts").text(numeral(n.TotalDiscounts).format("0,0")),$(".balance").text(numeral(n.Balance).format("0,0")),$(".clientName").text(n.ClientName).attr("href","ClientCars.aspx?id="+cid))},f=function(){cid=cid==0?"":cid;var n=$("#listItems").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],bServerSide:!0,bRetrieve:!1,bDestroy:!0,stateSave:!0,sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(n){n.push({name:"funName",value:"ClientsPayments_SelectList"},{name:"names",value:"ClientID"},{name:"values",value:cid})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i)},commonManger.errorException)},fnFooterCallback:function(n,t){for(var r=0,i=0;i<t.length;i++)r+=parseFloat(t[i].Amount)*1;$("strong.debit").text(numeral(r).format("0,0"))},iDisplayLength:50,aaSorting:[],aoColumns:[{mDataProp:"ClientPaymentsID",bSortable:!0,mData:function(n){return'<a href="ClientsPaymentsPrint.aspx?id='+n.ClientPaymentsID+'">'+n.ReceiptID+"<\/a>"}},{mDataProp:"CheckNo",bSortable:!0,mData:function(n){return n.CheckNo?n.CheckNo:""}},{mDataProp:"full_name",bSortable:!0,mData:function(n){return'<a href="ClientCars.aspx?id='+n.ClientID+'" title="حساب العميل">'+n.full_name+"<\/a>"}},{mDataProp:"PaymentsDates",bSortable:!0,mData:function(n){return n.PaymentsDates?commonManger.dateFormat(n.PaymentsDates,"M/D/YYYY","DD/MM/YYYY"):""}},{mDataProp:"ExchangeCompanyNameAr",bSortable:!0,mData:function(n){return n.ExchangeCompanyNameAr?n.ExchangeCompanyNameAr:""}},{mDataProp:"AmountDhs",bSortable:!1,mData:function(n){return numeral(n.AmountDhs).format("0,0")}},{mDataProp:"Amount",bSortable:!1,mData:function(n){return numeral(n.Amount).format("0,0")}},{bSortable:!1,sClass:"hidden-print",mData:function(n){return'<div class="tools pull-left hidden-print"><a href="ClientsPaymentsPrint.aspx?id='+n.ClientPaymentsID+'" class="btn btn-mini btn-success" data-rel="tooltip" title="طباعة" data-original-title="طباعة"><i class="icon-print"><\/i><\/a> '+t()+"<\/div>"}}]});$("#listItems tbody").delegate("tr button","click",function(t){var r,u,i;if(t.preventDefault(),r=$(this),u=r.closest("tr").index(),u!==null&&r.hasClass("remove"))i=n.row(u).data(),$("#ReceiptID").val(i.ReceiptID),$("#ClientPaymentID").val(i.ClientPaymentsID),$("#PaymentsDates").val(i.PaymentsDates),$("#Amount").val(i.Amount),$("#full_name").val(i.full_name),commonManger.showPopUpDialog("إلغاء إيداع عميل","insert","cancelModal")})},e=function(){cid=!cid||cid==0?"":cid;var n=$("#listItems2").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],bServerSide:!0,bRetrieve:!1,bDestroy:!0,sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(n){n.push({name:"funName",value:"ClientDiscounts_SelectList"},{name:"names",value:"ClientID"},{name:"values",value:cid})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i)},commonManger.errorException)},iDisplayLength:50,aaSorting:[],aoColumns:[{mDataProp:"DiscountAmount",bSortable:!0,mData:function(n){return numeral(n.DiscountAmount).format("0,0")}},{mDataProp:"AddDate",bSortable:!0,mData:function(n){return commonManger.formatJSONDateCal(n.AddDate)}},{mDataProp:"CarID",bSortable:!0},{mDataProp:"Notes",bSortable:!0}]})},o=function(){cid=cid==0?"":cid;var n=$("#listItems3").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],bServerSide:!0,bRetrieve:!1,saveState:!0,bDestroy:!0,sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(n){n.push({name:"funName",value:"ClientsMoneyBacks_List"},{name:"names",value:"ClientID"},{name:"values",value:cid})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i)},commonManger.errorException)},iDisplayLength:50,aaSorting:[],aoColumns:[{mDataProp:"ReceiptID",bSortable:!0,mData:function(n){return'<a title="طباعة سند الصرف" target="_blank" href="ReceiptPaymentsPrint.aspx?id='+n.ReceiptID+'">'+n.ReceiptID+"<\/a>"}},{mDataProp:"AddDate",bSortable:!0,mData:function(n){return commonManger.formatJSONDateCal(n.AddDate)}},{mDataProp:"Amount",bSortable:!1,mData:function(n){return numeral(n.Amount).format("0,0")}},{mDataProp:"Notes",bSortable:!1}]})},s=function(){cid=cid==0?"":cid;var n=$("#listItems4").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],bServerSide:!0,bRetrieve:!1,saveState:!0,bDestroy:!0,sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(n){n.push({name:"funName",value:"ClientsBonus_SelectList"},{name:"names",value:"ClientID~Revised"},{name:"values",value:cid+"~1"})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i)},commonManger.errorException)},iDisplayLength:50,aaSorting:[],aoColumns:[{mDataProp:"BonusID",bSortable:!0,mData:function(n){return'<a title="التفاصيل" target="_blank" href="ClientBonusPrint.aspx?id='+n.BonusID+'">'+n.BonusID+"<\/a>"}},{mDataProp:"AddDate",bSortable:!0,mData:function(n){return commonManger.formatJSONDateCal(n.AddDate)}},{mDataProp:"Amount",bSortable:!1,mData:function(n){return numeral(n.Amount).format("0,0")}},{mDataProp:"Notes",bSortable:!1},{bSortable:!1,sClass:"hidden-print",mData:function(n){return'<a href="ClientBonusPrint.aspx?id='+n.BonusID+'" class="btn btn-mini btn-success" title="طباعة"><i class="icon-print"><\/i><\/a> '+t()}}]});$("#listItems4 tbody").delegate("tr button","click",function(t){var i,r,u;if(t.preventDefault(),i=$(this),r=i.closest("tr").index(),r!==null&&i.hasClass("remove"))u=n.row(r).data(),$("#BonusID").val(u.BonusID),$(".Amount").val(numeral(u.Amount).format("0,0")),$(".full_name").val($("a.clientName").text()),commonManger.showPopUpDialog("إلغاء تخفيض","save","cancelBonus")})};return{Init:i}}();