var pageManager=function(){var t=$("#listItems"),r=$("#DateFrom"),u=$("#DateTo"),i=$("#AuctionTypeID"),n=$("#ExtraAmount"),f=function(n,t){$(t).each(function(t,i){$("#"+n).append($("<option />").val(i.ID).text(i.Name))});$("#"+n).trigger("chosen:updated").trigger("liszt:updated")},e=function(){var t=$("#CommAmount").val(),n=$("#ExchangeCompanyID").find("option:selected").text().split(":")[1],r=$("#VAT").val()!==""?$("#VAT").val()*1:0,i;n=n!==undefined&&n!==null&&n>0?n:3.674;t=t?t:0;i=parseFloat(t)*parseFloat(n);i+=parseFloat($("#Convertamount").val());r>0&&(i+=r);$("#CommAmountDhs").val(i.toFixed(2))},h=function(){var n=function(n){var t=commonManger.comp2json(n.d),i=t.list,r=t.list1,u=t.list2;i&&f("ExchangeCompanyID",i);r&&f("AuctionTypeID",r);u&&f("CommissionExtraNoteID",u)};dataService.callAjax("Post",JSON.stringify({actionName:"AuctionCommPayments_Properties",value:""}),sUrl+"GetData",n,commonManger.errorException)},o=function(){var i=0,r=n.val();t.find("tbody tr").each(function(){var n=$(this).find("td:nth-child(9)").text();i+=parseFloat(n)});r*1>0&&(i+=r*1);i>0?($("#CommAmount").val(i),$("#AuctionCommTotal").text(i),e(),$(".btnFinish").removeClass("hidden")):$(".btnFinish").addClass("hidden")},s=function(){var n=t.dataTable({sDom:"t",bProcessing:!0,bServerSide:!0,responsive:!0,bRetrieve:!1,bDestroy:!0,sAjaxSource:"AuctionCommissionAdd.aspx/LoadData",fnServerParams:function(n){n.push({name:"AuctionTypeID",value:i.val()},{name:"From",value:commonManger.dateFormat(r.val())},{name:"To",value:commonManger.dateFormat(u.val())});var t=commonManger.getQueryStrs().id;t&&t*1>0&&n.push({name:"PID",value:t})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){i(n.d);o()},commonManger.errorException)},fnRowCallback:function(n,t,i){$(n).find("td:nth-child(1)").text(i+1)},iDisplayLength:500,aaSorting:[],aoColumns:[{mDataProp:"CarID",bSortable:!0},{mDataProp:"TypeNameEn",bSortable:!0,mData:function(n){return'<a title="تفاصيل السيارة" href="CarDetailsPrint.aspx?id='+n.CarID+'">'+n.MakerNameEn+" - "+n.TypeNameEn+" - "+n.Year+(n.PayInvTypeID===3?" - Relist":"")+"<\/a>"}},{mDataProp:"LotNo",bSortable:!0},{mDataProp:"ChassisNo",bSortable:!0},{mData:"BuyerName",bSearchable:!1,bSortable:!1},{mDataProp:"RegionEn",bSortable:!1},{mDataProp:"CarID",bVisible:!1},{mData:"BuyerFee",bSortable:!1},{bSortable:!1,mData:function(n){return'<input type="text" id="extra_'+n.CarID+'" value="'+(n.AuctionCommCost?numeral(n.AuctionCommCost).format("0"):0)+'" class="span6" />'}},{bSortable:!1,mData:function(n){return n.BuyerFee*1+n.AuctionCommCost*1}}]})},k=function(n,t){var i={values:t,actionName:"AuctionCommPayments_Save",Parm_names:n};dataService.callAjax("Post",JSON.stringify(i),mainServiceUrl+"saveDefaultData",function(n){n.d.Status?window.location.href="AuctionCommissionview.aspx":commonManger.showMessage("خطأ أثناء الحفظ",n.d.message)},commonManger.errorException)},c=function(){dataService.callAjax("Post",JSON.stringify({value:""}),mainServiceUrl+"GetConvetAmount",function(n){var t=JSON.parse(n.d);$.each(t,function(n,t){$("#Convertamount").val(t.Convertamount)})},commonManger.errorException)},l=function(n){n.d.ID>0&&(commonManger.showMessage("تم الحفظ بنجاح:",n.d.message),document.location.href="AuctionCommissionPrint.aspx?id="+n.d.ID)},a=function(){var n=commonManger.getQueryStrs().id;n=commonManger.getNumbersFromString(n);n&&n*1>0&&y(n)},v=function(){$(".chzn-select").chosen({allow_single_deselect:!0,no_results_text:"اختـــر",search_contains:!1}).trigger("chosen:updated")},y=function(n){var t=function(n){var t=commonManger.comp2json(n.d),i=t.list,r=t.list1;$.each(i,function(n,t){$("#"+n).val(t)});v();$(".date-picker").val(function(){return commonManger.formatJSONDateCal($(this).val())});$(".money").val(function(){return numeral($(this).val()).format("0.00")});s()},i={actionName:"AuctionCommissions_SelectOne",value:n};dataService.callAjax("Post",JSON.stringify(i),sUrl+"GetData",t,commonManger.errorException)},p=function(){$("#SaveAll").on("click",function(f){var o,s;f.preventDefault();var h=[$("#AuctionCommID").val(),i.val(),$("#ExchangeCompanyID").val(),commonManger.dateFormat($("#InvoiceDate").val()),$("#CommAmount").val(),$("#ConvertAmount").val(),$("#CommAmountDhs").val(),$("#Notes").val(),commonManger.dateFormat(r.val()),commonManger.dateFormat(u.val()),n.val(),$("#CommissionExtraNoteID").val(),$("#VAT").val()],e=[],c=$("#listItems").dataTable().fnGetData();$(c).each(function(n,i){var r="0,0,"+i.CarID+","+i.BuyerFee+","+$("#extra_"+i.CarID).val()+","+t.find("tbody tr:eq("+n+") td:nth-child(9)").text();e.push(r)});e.length>0?n.val()*1==0||n.val()*1>0&&$("#CommissionExtraNoteID").val()!==""&&$("#ExchangeCompanyID").val()!==""?(o={masterValues:h,detailsValues:e},s="AuctionCommissionAdd.aspx/SaveDataMasterDetails",dataService.callAjax("Post",JSON.stringify(o),s,l,commonManger.errorException)):(commonManger.showMessage("يجب اختيار البيان:","برجاء تحديد بيان المبلغ الاضافى."),$("#CommissionExtraNoteID").focus()):commonManger.showMessage("لا توجد سيارات:","برجاء البحث عن سيارات بأعلى لاضافتها للحوالة.")});$("#ExchangeCompanyID").change(function(){e()});$(".btnSearch").click(function(n){n.preventDefault();s()});$("#VAT").change(function(){e()});i.change(function(n){n.preventDefault();$(this).val()!==""&&s()});n.change(function(){o()});$(document).delegate("#listItems tbody tr input.span6","keyup",function(n){n.preventDefault();var r=$(this),u=r.closest("tr").index(),i,f=t.dataTable();if(u!==null){i=f.fnGetData(u);var e=i.CarID,s=i.BuyerFee,h=$("#extra_"+e).val();r.closest("tr").find("td:nth-child(9)").text(parseFloat(h)+parseFloat(s));o()}})},w=function(){t=$("#listItems");r=$("#DateFrom");u=$("#DateTo");i=$("#AuctionTypeID");n=$("#ExtraAmount")},b=function(){w();h();c();a();p()};return{init:b}}();