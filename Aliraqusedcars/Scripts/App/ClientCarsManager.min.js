var pageManager=function(){"use strict";var n=commonManger.getUrlVars().id,t,u=0,c=function(){l();a()},l=function(){t=$("#doneFlag");n=commonManger.getNumbersFromString(n);u=commonManger.getUrlVars().selcarid;n!=="0"&&k();$("#addnew-dicount").attr("href","ClientDiscounts.aspx?id="+n);$("#addnew-extra").attr("href","ClientExtras.aspx?id="+n);$(".lnk-pay").attr("href","ClientsPaymentsView.aspx?id="+n);$(".lnkClientCars").attr("href","ClientFinishedCars.aspx?id="+n);$(".addPay").attr("href","ClientsPaymentsAdd.aspx?cid="+n)},d=function(){},i=function(n,t){t===!0?(n.addClass("disabled").prop("disabled",!0).text("قيد التنفيذ..."),$("#listItems tbody td a.waitingPay").removeAttr("href")):n.removeClass("disabled").removeAttr("disabled").text(function(){return $(this).attr("data-text")})},a=function(){$("#carTabs li a").click(function(n){n.preventDefault();var i=$(this);i.closest("li").hasClass("active")||(t.val(i.data("id")),t.val()<2?s():w())});$("#cancelModal .modal-footer .btn-danger").on("click",function(n){var t,u;if(n.preventDefault(),i($(this),!0),t=$("#cancelInvoiceID").val(),u=$("#cancelNotes").val(),t&&u!=""){var f={value:t,reason:u};commonManger.doWork("cancelModal","aspnetForm","clientcars.aspx/Cancel",f,r,commonManger.errorException)}else commonManger.showMessage("بيانات مطلوبة","يرجي التحقق من رقم السيارة وسبب الحذف أولاً."),$("#cancelNotes").focus()});$("#undoInstallmentModal .modal-footer .btn-danger").on("click",function(n){var t;if(n.preventDefault(),i($(this),!0),t={carNo:$("#undoCarID").text(),clientID:$("#undoClientID").val(),installmentTypeID:$("#undoInstallmentTypeID").val(),reason:$("#undoNotes").val()},t.carNo!=""&&t.reason!=""){var u={values:[t.carNo,t.clientID,t.installmentTypeID,t.reason,""]};commonManger.doWork("cancelModal","aspnetForm","clientcars.aspx/CancelInstallment",u,r,commonManger.errorException)}else $("#undoNotes").focus(),commonManger.showMessage("سبب الإلغاء مطلوب","يرجي ادخال سبب الحذف أولاً.")});$("#paymentModal .modal-footer button.btn-success").on("click",function(t){var f;t.preventDefault();i($(this),!0);var e=commonManger.getNumbersFromString(n),u=[];u.push("0",e,$("#CarID").val(),commonManger.getNumbersFromString($(".Amount").text().replace(",","")),$("#InstallmentTypeID").val(),0);f={values:u};commonManger.doWork("paymentModal","aspnetForm","clientcars.aspx/Save",f,r,commonManger.errorException)});$("#paperModal .modal-footer button.btn-success").on("click",function(n){var u,f;n.preventDefault();var e=$("#paperInvoiceID").val(),i=$("#paperCarID").val(),t=$("input[name=ReceiveWithPaper]:checked","#aspnetForm").val(),o=function(n){if(t==="true"){commonManger.showMessage("تم تنفيذ الإجراء بنجاح.",n.d.Message);var i=$("#paperDestID").val();if(i==1){window.location.href="signature/signature.aspx?id="+e+"&type=1";return}$(".modal").modal("hide")}r(n)};t&&i!==""?(u=[i,t],f={values:u},commonManger.doWork("paperModal","aspnetForm","clientcars.aspx/SavePaper",f,o,commonManger.errorException)):($(".modal").modal("hide"),commonManger.showMessage("وصول السيارة","لم يتم تسليم السيارة."))});$("#discountModal .modal-footer button.btn-success").on("click",function(n){var f,e;n.preventDefault();i($(this),!0);var t=$("#discountCarID").val(),u=$("input[name=CarDiscount]","#aspnetForm").val();u>0&&t!==""?(f=[t,u],e={values:f},commonManger.doWork("discountModal","aspnetForm","clientcars.aspx/SaveDiscount",e,r,commonManger.errorException)):commonManger.showMessage("لم يتم الحفظ:","برجاء ادخال مبلغ الخصم على السيارة.")});$("#listItems").on("click","td i.amountDetails",function(n){n.preventDefault();var t=$(this),i={carid:t.data("id"),type:t.data("amount-type")},r="PrintCar"+i.type+".aspx?id="+i.carid,u=window.open(r,"","menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=no,height=400,width=600,top=50,left=100,",!0);setTimeout(function(){u.close()},1e4)});$(".modal").on("show.bs.modal",function(){i($('div[id$=Modal].modal .modal-footer .btn[type="submit"]'),!1);var n=$(this),t=n.find(".modal-footer button.btn-success").eq(0);t.focus();return});var u=$("#moneyBack"),e=$('input[name="money"]'),o="ReceiptPaymentsAdd.aspx?ids="+n;$(".btn-money-back").on("click",function(){var n=numeral().unformat($("strong.clear:eq(0)").text());e.val(n);u.find(".modal-footer a.btn-success").attr("href",o+"&cusd="+n)});e.on("keyup",function(){u.find(".modal-footer a.btn-success").attr("href",o+"&cusd="+$(this).val())});f()},f=function(){$('[data-toggle="tooltip"],[data-rel=tooltip],.ace-tooltip').tooltip({delay:0}).on("hide.bs.tooltip",function(){$("div.tooltip").hide()});$(document).on("mouseleave",'[data-toggle="tooltip"],[data-rel=tooltip],.ace-tooltip',function(){$(this).tooltip("hide");$(".tooltip.fade.in").remove()})},g=function(){var t={actionName:"Client_ResetBalance",value:n},i=function(n){var t=commonManger.comp2json(n.d),r=t.list,i=t.list1;i&&(o(i),commonManger.showMessage("تم تحديث الرصيد","تم تحديث رصيد العميل بنجاح."))};dataService.callAjax("POST",JSON.stringify(t),sUrl+"GetData",i,commonManger.errorException)},r=function(n){n=n.d;$("div[id$=Modal].modal").modal("hide");i($('div[id$=Modal].modal.fade.in .modal-footer .btn[type="submit"]'),!1);commonManger.showMessage("تم تنفيذ الإجراء:",n.Message);n.Status&&s()},e=function(n){return+n==n&&n.length>0},v=function(){for(var t,i=0,n=0,r=arguments.length;n<r;n++)t=arguments[n],e(t)&&(i+=parseFloat(t));return i},y=function(n){n&&(n[1]&&$(".nextCar").html(n[1].full_name+' <i class="icon-arrow-left"><\/i>').attr("href","ClientCars.aspx?id="+n[1].ClientID).removeClass("hidden"),n[0]&&$(".prevCar").html('<i class="icon-arrow-right"><\/i> '+n[0].full_name).attr("href","ClientCars.aspx?id="+n[0].ClientID).removeClass("hidden"))},p=function(){var n,i,t;u&&(n=$("#listItems td").filter(function(){return $(this).text()==u}).closest("tr"),i=n?n.attr("class"):"",n&&($(n).attr("class","selected-car"),t=n.position(),t&&setTimeout(function(){$(document).scrollTop(t.top)},500)))},o=function(t){var e=$(".totalRequired"),f=$(".debit"),r,i,u;t.full_name&&($(".clientName").html(t.full_name),$(".addBonus").attr("href","ClientBonusAdd.aspx?cid="+n+"&cname="+t.full_name.split(" ").join("-")));$(".carsRequired").text(numeral(t.PresentRequired).format("0,0"));r=t.PresentRequired*1;e.text(numeral(r).format("0,0"));i=t.BalanceDebit*1-t.BalanceCredit*1;f.text(numeral(i).format("0,0"));i<0?f.removeClass("green").addClass("red balance-notes").attr("title"," تم إلغاء إيداعات عملاء بعد السداد منها، يرجي اضافة ايداعات بهذه القيمة مرة أخري."):i>0&&$(".btn-refresh-balance").removeClass("hidden");u=i-r;$(".clear").text(numeral(u).format("0,0"));u>0&&$("a.btn-money-back").removeClass("hidden");$("#listItems a.pay strong").each(function(){$(this).text().replace(",","")*1>i&&$(this).parent().replaceWith('<strong data-rel="tooltip" title="الرصيد لا يكفى لسداد المبلغ">'+$(this).html()+"<\/strong>")})},s=function(){$("#listItems").DataTable().draw()},w=function(){$("#listItems2").DataTable().draw()},b=function(n,t){var i=!1;return $.map(n,function(n){n.CarID==t&&(i=!0)}),i},h=function(n){return n.Arrived==="true"||n.WithoutShipping==="true"},k=function(){var r='<a data-rel="tooltip" title="تراجع عن السداد" href="javascript:void(0);" class="undo"><i class="icon-undo bigger-120"><\/i><\/a>',i=$("#listItems").DataTable({sDom:"<'row-fluid hidden-print'<'span6 'l><'span6 lft-pane'BfT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{extend:"copy",text:"نسـخ"},{text:"طباعة",action:function(){window.print()}}],responsive:!0,language:{search:"_INPUT_",searchPlaceholder:"برقم السيارة"},bServerSide:!0,bDestroy:!0,iDisplayLength:50,saveState:!0,stateSaveCallback:function(n,t){localStorage.setItem("DTCC_"+n.sInstance,JSON.stringify(t))},stateLoadCallback:function(n){return JSON.parse(localStorage.getItem("DTCC_"+n.sInstance))},sAjaxSource:"clientcars.aspx/LoadData",fnServerParams:function(i){i.push({name:"client",value:n},{name:"selectedCarId",value:u},{name:"done",value:t.val()})},fnServerData:function(n,i,r){var u=function(n){var e=commonManger.comp2json(n.d),h=e.list,u=e.list1,l=e.list2,w=e.list3,a=e.list4,c=e.list5,s,v,p;u=u?$.map(u,function(n){return n}):[0];s=$.isArray(h)?h:$.makeArray(h);c&&(v=b(s,c.CarID),v||(s.unshift(c),u[0]=u[0]*1+1));p={sEcho:i.sEcho?i.sEcho:0,iTotalRecords:u[0],iTotalDisplayRecords:u[0],aaData:s};r(p);l&&t.val()==0&&o(l);y(w);f();a&&commonManger.fullRoles()&&$("a.addBonus").attr({href:"ClientBonusAdd.aspx?id="+a.BonusID,title:"لديك منحة/بونص/تعويض لعميل فى انتظار الموافقة عليه.","data-original-title":"لديك منحة/بونص/تعويض لعميل فى انتظار الموافقة عليه."}).find("span.newBonus").removeClass("hidden").text(1)};dataService.callAjax("GET",i,n,u,commonManger.errorException)},fnRowCallback:function(n,i){if(i.PayInvTypeID==="3"&&$(n).addClass("car-relist"),i.ShippingCalcID==="2"&&$(n).addClass("warning").attr("title","سيارة سكراب"),t.val()===1){var r=$(n).find("td strong.carRequired");r.text()==="0"&&(i.Arrived==="true"||oObj.WithoutShipping==="true"||oObj.SalePriceDemand==="true")&&$(n).addClass("hidden")}},fnFooterCallback:function(n,t){for(var u=0,f=0,e=0,o=0,s=0,i=0;i<t.length;i++){var r=t[i].Arrived=="true"||t[i].WithoutShipping=="true",c=t[i].SaleTypeID==1||r||t[i].SalePriceDemand!="true",h=t[i].SalePriceDemand==="true"&&t[i].SaleTypeID==1;s+=t[i].SalePrice*1;u+=t[i].CarRetainerDone*1>0?0:c?t[i].CarRetainer*1:0;f+=t[i].CarDelayedDone*1>0?0:t[i].DelayedAfterDisc*1;(r||h)&&(e+=t[i].CarDelayedDone*1>0?0:t[i].DelayedAfterDisc*1);r||h||(o+=t[i].CarDelayedDone*1>0?0:t[i].DelayedAfterDisc*1)}$(n).find("th:eq(1)").html(numeral(s).format("0,0"));$(n).find("th:eq(2)").html(numeral(u).format("0,0"));$(".total-delayed").text(numeral(f).format("0,0"));$(".arrived-delayed").text(numeral(e).format("0,0"));$(".not-arrived-delayed").text(numeral(o).format("0,0"))},fnInfoCallback:function(n,t,i,r,u){var f=new $.fn.dataTable.Api(n),e=f.rows({page:"current"}).data().length,o=e+" \\ "+u;$(".dataTables_info").text(o);p()},aaSorting:[],aoColumns:[{bSortable:!0,mData:function(n){return'<a data-rel="tooltip" title="# '+n.SaleInvoiceID+" التاريخ: "+commonManger.formatJSONDateCal(n.InvoiceDate)+'" href="InvoiceSalePrint.aspx?id='+n.SaleInvoiceID+'">'+n.CarID+"<\/a>"}},{mDataProp:"MainPicture",bSortable:!1,mData:function(n){return n.MainPicture!=null?'<a data-rel="tooltip" title="صور السيارة رقم: '+n.CarID+'" href="images.aspx?id='+n.CarID+'"><img alt="car" width="50" src="/public/cars/'+n.CarID+"/_thumb/"+n.MainPicture+'" /><\/a>':'<a href="images.aspx?id='+n.CarID+'"><img alt="car" width="50" src="/public/cars/noimage.gif" /><\/a>'}},{mDataProp:"ChassisNo",bSortable:!1,mData:function(n){return'<a data-rel="tooltip" title="عرض تفاصيل السيارة" href="CarDetailsPrint.aspx?id='+n.CarID+'">'+n.MakerNameAr+" - "+n.TypeNameAr+" - "+n.Year+(n.PayInvTypeID==3?" - Relist":"")+'<\/a><br><span data-rel="tooltip" title="الشاصي: '+n.ChassisNo+'">'+n.ChassisNo.substr(-8)+'<\/span> | <span title="اللوت">'+n.LotNo+"<\/span>"}},{mDataProp:"SalePrice",bSortable:!1,mData:function(n){return'<span class="red" data-rel="tooltip" title="سعر الشراء:  '+numeral(n.PayPrice).format("0,0")+"$،\nالعمولة: "+numeral(n.SalePrice-n.PayPrice).format("0,0")+'$">'+numeral(n.SalePrice).format("0,0")+"<\/span> "}},{mDataProp:"CarRetainer",bSortable:!1,mData:function(n){return n.CarRetainer*1>0?n.CarRetainerDone*1>0?'<s class="red" data-rel="tooltip" title="تم السداد">'+numeral(n.CarRetainer).format("0,0")+"<\/s> "+r:!h(n)&&n.SalePriceDemand==="true"&&n.SaleTypeID>1?'<strong data-rel="tooltip" class="text-hide" title="غير مفعل : السيارة غير واصه">'+numeral(n.CarRetainer).format("0,0")+"<\/strong>":'<a href="javascript:void(0);" data-rel="tooltip" data-original-title="سداد العربون الآن" title="سداد العربون الآن" class="pay"><strong class="text-black">'+numeral(n.CarRetainer).format("0,0")+"<\/strong><\/a>":""}},{bSortable:!1,mData:function(n){return n.DelayedAfterDisc*1>0?n.CarDelayedDone*1>0?'<s class="red ace-tooltip" data-rel="tooltip" title="تم السداد">'+numeral(n.DelayedAfterDisc).format("0,0")+"<\/s> "+r:!h(n)&&(n.SalePriceDemand!="true"||n.SaleTypeID>1)?'<strong data-rel="tooltip" class="text-hide" title="غير مفعل : السيارة غير واصه">'+numeral(n.DelayedAfterDisc).format("0,0")+"<\/strong>":'<a href="javascript:void(0);" data-rel="tooltip" title="سداد المتبقى الآن" class="pay"><strong class="text-black">'+numeral(n.DelayedAfterDisc).format("0,0")+"<\/strong><\/a>":""}},{mDataProp:"TotalCarShippExpenses",bSortable:!1,mData:function(n){var t='<a data-rel="tooltip" href="CarShippExpenses.aspx?id='+n.CarID+'" title="اضافة مصروف شحن"><i class="icon-plus"><\/a><\/a>';return n.TotalCarShippExpenses*1>0?n.TotalCarShippExpensesDone*1>0?'<s class="red ace-tooltip" data-rel="tooltip" title="تم السداد">'+numeral(n.TotalCarShippExpenses).format("0,0")+"<\/s> "+r:'<a href="javascript:void(0);" data-rel="tooltip" title="سداد مصروف الشحن الآن" class="pay"><strong class="text-black">'+numeral(n.TotalCarShippExpenses).format("0,0")+"<\/strong><\/a> "+t:n.Arrived==="true"||n.WithoutShipping==="true"?t:"---"}},{mDataProp:"TotalCarShopExpenses",bSortable:!1,mData:function(n){var t='<a data-rel="tooltip" href="CarShopExpenses.aspx?id='+n.CarID+'" title="اضافة مصروف ورشة"><i class="icon-plus"><\/a><\/a>';return n.TotalCarShopExpenses*1>0?n.TotalCarShopExpensesDone*1>0?'<s class="red ace-tooltip" data-rel="tooltip" title="تم السداد">'+numeral(n.TotalCarShopExpenses).format("0,0")+"<\/s> "+r:'<a href="javascript:void(0);" data-rel="tooltip" title="سداد مصروف الورشة الآن" class="pay"><strong class="text-black">'+numeral(n.TotalCarShopExpenses).format("0,0")+"<\/strong><\/a> "+t:n.Arrived==="true"||n.WithoutShipping==="true"?t:"---"}},{bSortable:!1,mData:function(n){var t=n.TotalCarShippExpenses*1+n.TotalCarShopExpenses*1,i=n.Arrived==="true"||n.WithoutShipping==="true";(n.SaleTypeID==1||i||n.SalePriceDemand!="true")&&(t+=n.CarRetainer*1);(i||n.SalePriceDemand==="true"&&n.SaleTypeID==="1"||n.CarDelayedDone*1>0)&&(t+=parseFloat(n.CarDelayed)-parseFloat(n.CarDiscount));var u=n.CarRetainerDone*1+n.CarDelayedDone*1+n.TotalCarShippExpensesDone*1+n.TotalCarShopExpensesDone*1,f=t-u,e=n.ClientDiscountOnCar>0?'<i data-id="'+n.CarID+'" data-amount-type="discount" title="خصم: '+numeral(n.ClientDiscountOnCar).format("0,0")+'" data-rel="tooltip" class="green icon-smile bigger-200 amountDetails"><\/i>':"",r='<i data-id="'+n.CarID+'" title="زيادة: '+(n.ClientExtraOnCar*1>0?numeral(n.ClientExtraOnCar).format("0,0"):"")+'" data-rel="tooltip" data-amount-type="extra" class="red icon-frown bigger-200 amountDetails"><\/i> ',o=n.ClientExtraOnCar*1>0?r+(n.SaleTypeID==1||i||n.SalePriceDemand!="true"?'<a href="javascript:void(0);" class="pay payExtra inline" data-rel="tooltip" title="سداد مبلغ الزيادة"><strong class="text-black">'+numeral(n.ClientExtraOnCar).format("0,0")+"<\/strong><\/a>":""):"",s=n.ClientExtraOnCar*1==0&&n.ClientExtraOnCarPaid*1>0?r+'<s data-rel="tooltip" title="تم السداد"  class="red ace-tooltip inline">'+numeral(n.ClientExtraOnCarPaid).format("0,0")+"<\/s>":o;return'<strong data-rel="tooltip" class="carRequired" title="المطلوب على السيارة">'+numeral(f).format("0,0")+"<\/strong> &nbsp;"+e+" "+s}},{bSortable:!1,mData:function(n){return n.PayInvTypeID===3?"---":n.Arrived==="true"||n.WithoutShipping==="true"?'<img src="/App_Themes/iraq/images/'+n.DistinationNameEn+'.jpg" width="25" /> '+n.DistinationNameAr:'<img src="/App_Themes/iraq/images/USA.jpg" width="25" /> أمريكا'}},{bSortable:!1,mData:function(n){if(n.Arrived==="true"||n.WithoutShipping==="true"){var t=n.ReceiveWithPaper!=null?'<a class="hidden-print" title="استلام أوراق السيارة" href="signature/signature.aspx?id='+n.SaleInvoiceID+'&type=1"><i class="icon-print"><\/i><\/a>':"",i='<a data-rel="tooltip" href="javascript:void(0);" class="car-paper" title="تسليم السيارة">'+(n.ReceiveWithPaper?n.ReceiveWithPaper=="true"?"بالورق":"بدون الورق":"لم تسلم")+"<\/a> ";return i+t}return"---"}},{bSortable:!1,sClass:"center hidden-print"+(commonManger.fullRoles()!==!0?" hidden":""),mData:function(n){var t=n.CarRetainerDone*1+n.CarDelayedDone*1+n.TotalCarShippExpensesDone*1+n.TotalCarShopExpensesDone*1;return t*1>0?"---":'<a class="btn btn-mini btn-danger remove" href="javascript:void(0);" data-rel="tooltip" title="إلغاء الفاتورة"><i class="icon-remove"><\/i><\/a>'}}]});$("#listItems:eq(0) tbody").delegate('tr a[href="javascript:void(0);"]',"click",function(n){var r,u,t,c,l,f,e,s;if(n.preventDefault(),r=$(this),u=r.closest("tr"),u!=null)if(r.hasClass("pay")){r.addClass("waitingPay");var f="سداد مبلغ",o="insert",e="paymentModal";t=i.row(u).data();c=r.text();$(".Amount").html(c);$("#CarID").val(t.CarID);s=r.closest("td").index();$("#InstallmentTypeID").val(s-3);commonManger.showPopUpDialog(f,o,e);l=$("#listItems thead th:eq("+s+")").text();$("#addModalLabel").append(" "+l+" على السيارة رقم: "+t.CarID)}else if(r.hasClass("car-place")){var f="وصول السيارة",o="insert",e="placeModal";t=i.row(u).data();$("input[name=CarID]").val(t.CarID);commonManger.showPopUpDialog(f,o,e)}else if(r.hasClass("car-paper")){var f="تسليم أوراق السيارة",o="insert",e="paperModal",t=i.row(u).data(),h=t.CarPaper;$("#ReceiveWithPaperNULL").prop("checked",!0);$(".savedPaper p").html("").closest("div.control-group").addClass("hidden");h&&h!==null&&$(".savedPaper p").html(h).closest("div.control-group").removeClass("hidden");$("#paperCarID").val(t.CarID);$("#paperInvoiceID").val(t.SaleInvoiceID);$("#paperDestID").val(t.DistinationID);$('input[type=radio][value="'+t.ReceiveWithPaper+'"]').first().attr("checked","checked");commonManger.showPopUpDialog(f,o,e)}else if(r.hasClass("car-discnt")){var f="الخصم على السيارة",o="insert",e="discountModal";t=i.row(u).data();$("#discountCarID").val(t.CarID);$("#CarDiscount").val(t.CarDiscount);commonManger.showPopUpDialog(f,o,e)}else if(r.hasClass("remove")){r.addClass("waitingPay");var f="إلغاء فاتورة البيع",o="insert",e="cancelModal";t=i.row(u).data();$("#cancelCarID").val(t.CarID);$("#cancelInvoiceID").val(t.SaleInvoiceID);$("#cancelCarModel").val(t.MakerNameAr+" - "+t.TypeNameAr+" "+t.Year);$("#cancelNotes").val("").focus();commonManger.showPopUpDialog(f,o,e)}else r.hasClass("undo")&&(r.addClass("waitingPay"),f="إلغاء (تراجع عن) السداد",e="undoInstallmentModal",t=i.row(u).data(),$("#undoForm input[id],#undoNotes").val(""),$("#undoForm lebel[id]").text(""),s=r.closest("td").index()-3,$("#undoCarID").text(t.CarID),$("#undoClientID").val(t.ClientID),$("#undoInstallmentTypeID").val(s),$("#undoCarModel").text(t.MakerNameAr+" - "+t.TypeNameAr+" "+t.Year),commonManger.showPopUpDialog(f,"save",e))})};return{Init:c,IsNumeric:e,successCallback:r,addition:v}}();