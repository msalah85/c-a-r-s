var ShippInvoicesManager=function(){var t="",e="",r="",u="",f="",n=$("#listItems").DataTable({sDom:"t",bDestroy:!0,iDisplayLength:50,bLengthChange:!1,bSortable:!1,bSort:!1,columnDefs:[{targets:[0],visible:!1},{targets:[1],visible:!1},{targets:[14],visible:!1},{targets:[15],visible:!1},{targets:[16],visible:!1}]}),v=$("select[id$=ddlShipper"),y=$("select[id$=ddlDistination]"),p=$("input[id$=ChassisNo]"),o=$("input[id$=txtBol]"),w=$("input[id$=txtContainerNo]"),b=function(){l();k()},k=function(){o.on("change",l);$("#txtLoadingCost, #txtShippPrice, #TransportationPrice").on("blur",function(n){n.preventDefault();var i=$("#CarsNo").val(),t=$("#txtLoadingCost").val(),r=$("#txtShippPrice").val(),u=$("#TransportationPrice").val();if(t*1>-1&&r*1>-1&&u*1>-1&&i>0){if(t*1<=0){commonManger.showMessage("لم تتم عملية التحديث","برجاء التأكد من  قيمة التحميل أكبر من الصفر.");return}if(s()){var f=sUrl+"GetDataList",e={actionName:"ShippInvoices_UpdateInvoiceExpens",names:["id","load","shipp","trans","count"],values:[$("#ShippInvoiceID").val(),t,r,u,i]},o=JSON.stringify(e);dataService.callAjax("POST",o,f,g,commonManger.errorException)}}else return commonManger.showMessage("لم تتم عملية التحديث","برجاء التأكد من  قيمة التحميل، الشحن البحري، ,التحميل وعدد السيارات أكبر من الصفر."),!1});$("button.btnAddCar").on("click",function(n){var r,t,e;if(n.preventDefault(),s()){r="InvoiceShippingAdd.aspx/SaveShippCar";t={};t.BillDetailsID=$("#BillDetailsID").val();t.CarID=$("#CarID").val();t.ShippInvoiceID=$("#ShippInvoiceID").val();t.Towing=$("#txtTowingCost").val();t.Notes=$("#Notes").val();var u=$("input[id$=txtShippPrice]").val(),f=$("input[id$=txtLoadingCost]").val(),i=$("input[id$=CarsNo]").val(),o=$("input[id$=TransportationPrice]").val();t.SeaTrans=u/i;t.Loading=f/i;t.Transportation=o/i;t.Partitioning=$("#txtCuttingCost").val()!==""?$("#txtCuttingCost").val():0;t.Extra=$("#txtExtraCost").val()!==""?$("#txtExtraCost").val():0;e={scParam:t};t.CarID!==""&&i*1>0&&u!==""&&f!==""&&d()&&dataService.callAjax("Post",JSON.stringify(e),r,c,commonManger.errorException)}});$("a.btnFinish").on("click",function(n){if(n.preventDefault(),s()){var t={IsDeleted:!1,ShippInvoiceID:$("#ShippInvoiceID").val(),CarsNo:$("input[id$=CarsNo]").val(),ContainerNo:$("input[id$=txtContainerNo]").val(),InvoiceDate:commonManger.dateFormat($("input[id$=txtBillDate]").val()),InvoiceNo:$("input[id$=txtBillNo]").val(),ShippPrice:$("input[id$=txtShippPrice]").val(),LoadingPrice:$("input[id$=txtLoadingCost]").val(),TransportationPrice:$("input[id$=TransportationPrice]").val(),TotalAmount:$("#lblInvoiceTotal").text(),ShipperID:$("select[id$=ddlShipper] option:selected").val(),ContainerSize:$("select[id$=ddlContainerSize] option:selected").val(),DistinationID:$("select[id$=ddlDistination] option:selected").val(),ArrivalDate:$("input[id$=txtArriveDate]").val()!==""?commonManger.dateFormat($("input[id$=txtArriveDate]").val()):null,Bol:$("input[id$=txtBol]").val(),NavigationCoID:$("#NavigationCoID").val(),Notes:$("#txtNotes").val(),IsBol:$("#IsBol").val()},i=$("#listItems tbody tr").length,r={scParam:t};if(t.ShipperID!==undefined&&t.ShipperID!==""&&t.CarsNo!==""&&t.InvoiceNo!==""&&t.InvoiceDate!=="")if(t.CarsNo*1===i)dataService.callAjax("Post",JSON.stringify(r),"InvoiceShippingAdd.aspx/SaveInvoice",function(n){c(n);n.d.ID>0&&(window.location.href="InvoiceShippingPrint.aspx?id="+n.d.ID)},commonManger.errorException);else return commonManger.showMessage("لم تتم عملية الحفظ","برجاء التأكد من  عدد السيارات فى الفاتورة."),!1;else $("select[id$=ddlDistination]").focus()}});$("#listItems tbody").delegate("tr button","click",function(t){var f,r,i,u;t.preventDefault();f=$(this);r=f.closest("tr").index();r!==null&&(i=n.row(r).data(),f.hasClass("edit")&&($("#BillDetailsID").val(i[0]),$("#CarID").val(i[1]),p.val(i[3]),$("#txtExtraCost").val(i[10]),$("#txtTowingCost").val(i[5]).attr("data-value",i[14]?i[14]:0),$("#txtCuttingCost").val(i[8]).attr("data-value",i[15]?i[15]:0),$("#TransOnCar").val(i[9]).attr("data-value",i[16]?i[16]:0),$("#Notes").val(i[11]),$(".car-model").val(i[2]),$(".car-region").val(i[4]),$("#indexUpdate").val(r),u="القيمة الافتراضية: ",$("i.default-towing").attr("data-original-title",u+numeral(i[14]).format("0,0.00")),$("i.default-part").attr("data-original-title",u+numeral(i[15]?i[15]:0).format("0,0.00")),$("i.default-trans").attr("data-original-title",u+numeral(i[16]?i[16]:0).format("0,0.00")),h(!0)))});$.fn.afterLoadDatawithdata=function(n){e=n.CarShipperID;$("select[id$=ddlShipper]").val(n.CarShipperID)}},h=function(n){n=n===!0?"show":"hide";$("#editCarModal").modal(n)},d=function(){var n=$("input[id$=txtTowingCost]"),t=$("input[id$=txtCuttingCost]"),i=$("input[id$=txtCuttingCost]"),f=n.val(),e=t.val(),o=i.val(),s=n.attr("data-value"),r=t.attr("data-value"),u=i.attr("data-value"),h=parseFloat(f)<=parseFloat(s),c=r*1>0?parseFloat(e)<=parseFloat(r):!0,l=u*1>0?parseFloat(o)<=parseFloat(u):!0;return h===!0&&c===!0&&l===!0?!0:(commonManger.showMessage("خطأ بالحفظ:","برجاء التأكد من  قيمة التونك والتقطيع والنقل بحيث لا تكون أكبر من القيمة الافتراضية."),!1)},s=function(){var n=parseFloat($("input[id$=txtShippPrice]").val())<=parseFloat($("input[id$=txtShippPrice]").attr("data-value")),t=parseFloat($("input[id$=txtLoadingCost]").val())<=parseFloat($("input[id$=txtLoadingCost]").attr("data-value")),i=parseFloat($("input[id$=TransportationPrice]").val())<=parseFloat($("input[id$=TransportationPrice]").attr("data-value"));return n&&t&&i?!0:(commonManger.showMessage("لم تتم عملية الحفظ","برجاء التأكد من  قيمة الشحن البحرى والتحميل والسحب بحيث ألا تكون أكبر من القيمة الافتراضية."),!1)},c=function(t){var r,u,i;t=t.d;t.Status?(r=$("#indexUpdate").val(),n.cell(r,5).data($("#txtTowingCost").val()),n.cell(r,8).data($("#txtCuttingCost").val()),n.cell(r,9).data($("#Transportation").val()),n.cell(r,10).data($("#txtExtraCost").val()),n.cell(r,11).data($("#Notes").val()),u=0,i=n.rows(r).data(),i=i[0],u=parseFloat(i[5])+parseFloat(i[6])+parseFloat(i[7])+parseFloat(i[8])+parseFloat(i[9])+parseFloat(i[10]),n.cell(r,12).data(u.toFixed(2)),ut(),h(!1),nt(),commonManger.showMessage("تم تحديث البيانات",t.message)):commonManger.showMessage("خطأ أثناء تنفيذ الإجراء",t.Message)},g=function(n){var t=commonManger.comp2json(n.d),i=t.list;a(i);commonManger.showMessage("تم تحديث البيانات","تم تحديث مبلغ التحميل والشحن البحري والنقل للحاوية بنجاح.")},nt=function(){$("#divMyForm input").val("0")},tt=function(n){var t=0,r=n;for(i=0;i<r.length;i++)t+=r[i].TotalCost;$("#lblInvoiceTotal").text(t)},it=function(){return t!==undefined&&t!==""&&t!=="0"?!0:!1},l=function(){var n=o.val();if(t=commonManger.getUrlVars().id,t=t!==undefined&&t!==""?t:"0",n=n!==undefined&&n!==""?n:"0",t!=="0"||n!=="0"){var i=sUrl+"GetDataList",r={actionName:"ShippInvoices_GetByBol",names:["id","bol"],values:[t,n]},u=JSON.stringify(r);dataService.callAjax("POST",u,i,rt,commonManger.errorException)}},rt=function(n){var s=commonManger.comp2json(n.d),t=s.list,i="السعر الافتراضي: ",h,c;t!==undefined&&(t.Message===undefined?($("input[id$=CarsNo]").val(t.CarsNo),w.val(t.ContainerNo),o.val(t.Bol),$("#NavigationCoID").val(t.NavigationCoID),$("input[id$=txtBillNo]").val(t.InvoiceNo),$("input[id$=ShippInvoiceID]").val(t.ShippInvoiceID),$("select[id$=ddlContainerSize]").val(t.ContainerSize),r=numeral(t.LoadingPrice).format("0.00"),u=numeral(t.ShippPrice).format("0.00"),f=numeral(t.TransportationPrice).format("0.00"),$("input[id$=txtLoadingCost]").val(r).attr("data-value",numeral(t.DefaultLoading).format("0.00")),$("label[id$=lbltxtLoadingCost]").attr("data-original-title",i+numeral(t.DefaultLoading).format("0.00")),$("input[id$=txtShippPrice]").val(u).attr("data-value",numeral(t.DefaultOF).format("0.00")),$("label[id$=lbltxtShippPrice]").attr("data-original-title",i+numeral(t.DefaultOF).format("0.00")),$("input[id$=TransportationPrice]").val(f).attr("data-value",numeral(t.DefaultTrans).format("0.00")),$("label[id$=lblTransportationPrice]").attr("data-original-title",i+numeral(t.DefaultTrans).format("0.00")),t.InvoiceNo||(r<=0&&t.DefaultLoading>0&&$("input[id$=txtLoadingCost]").val(r<=0?numeral(t.DefaultLoading).format("0.00"):r).change(),u<=0&&t.DefaultOF>0&&$("input[id$=txtShippPrice]").val(u<=0?numeral(t.DefaultOF).format("0.00"):u).change(),f<=0&&t.DefaultTrans>0&&$("input[id$=TransportationPrice]").val(f<=0?numeral(t.DefaultTrans).format("0.00"):f).change()),e=t.ShipperID,y.val(t.DistinationID),v.val(e),t.InvoiceDate!==null&&(h=commonManger.formatJSONDateCal(t.InvoiceDate),$("input[id$=txtBillDate]").val(h)),t.ArrivalDate!==null&&(c=commonManger.formatJSONDateCal(t.ArrivalDate),$("input[id$=txtArriveDate]").val(c)),it()?a(s.list1):$("#txtLoadingCost").blur()):commonManger.showMessage("هذه الفاتورة موجودة من قبل","لا يمكن تعديل الفاتورة، نظراً لوجود حوالة لها فى النظام."))},a=function(t){n.clear().draw();var i=$("#lblInvoiceTotal");i.text(0);$(t).each(function(t,r){n.row.add([r.BillDetailsID,r.CarID,r.MakerNameEn+" - "+r.TypeNameEn+" - "+r.Year,r.ChassisNo,r.RegionEn,numeral(r.Towing).format("0.00"),numeral(r.Loading).format("0.00"),numeral(r.SeaTrans).format("0.00"),numeral(r.Partitioning).format("0.00"),numeral(r.Transportation).format("0.00"),numeral(r.Extra).format("0.00"),r.Notes,numeral(r.TotalCost).format("0.00"),'<button class="btn btn-minier btn-info edit" data-rel="tooltip" data-placement="top" data-original-title="تعديل"><i class="icon-edit"><\/i><\/button>',r.DefaultTowing,r.DefaultPartio?r.DefaultPartio:"",r.DefaultTransp?r.DefaultTransp:""]).draw();$(".btnFinish").removeClass("hidden");var u=parseFloat(i.text())+parseFloat(r.TotalCost);i.text(u.toFixed(2))})},ut=function(){var t=$("#lblInvoiceTotal"),i;t.text(0);i=n.rows().data();$(i).each(function(n,i){var r=parseFloat(t.text())+parseFloat(i[12]);t.text(r.toFixed(2))})};return{Init:b,ShowInvoiceTotal:tt}}();ShippInvoicesManager.Init();