var pageManager=function(){var t="",i="",r="",u="",f="",e={UAE:1,USA:2},o="frmAddNote",s="pnlReply",n="america/carnotes.aspx/",h=function(){$(".modal-footer textarea,.modal-footer input,.modal-footer select").val("");$(".ace-file-input .remove").trigger("click");$("#attchFile").attr("data-uploaded-file","")},c=function(){$("#"+o).addClass("hidden");$("#"+s).removeClass("hidden")},y=function(){g();l();p();b()},p=function(){$("#btnSearchAll").click(function(n){n.preventDefault();t=$("#BuyerID").val();r=$("#shipper").val();i=$("#ChassisN").val();u=$("#CarTitleAmrica").is(":checked")?1:"";f=$('[name="Title"]:checked').val()?$('[name="Title"]:checked').val():"";d()});$("#startReply").click(function(n){n.preventDefault();$("#"+o).removeClass("hidden");$("#"+s).addClass("hidden")});$("#btnCancelRepaying").click(function(n){n.preventDefault();c();h()});$("#bntSendNote").click(function(t){t.preventDefault();var i={carId:$("#CarID").val(),toID:e.UAE,note:$("#txtNote").val(),file:$("#attchFile").attr("data-uploaded-file")?$("#attchFile").attr("data-uploaded-file"):"",isSelf:!1},r=function(n){n.d?(h(),c(),v(i.carId)):(alert("Please reload the web page to review your login, Thanks"),window.location.reload())};i.note!=""?dataService.callAjax("Post",JSON.stringify(i),n+"ReplyNote",r,commonManger.errorException):($("#txtNote").focus(),commonManger.showMessage("Required fields:","Please enter your note first."))});$(".notes-body-contents").delegate("button.fastReply","click",function(t){t.preventDefault();var i=$(this),r=i.closest("form").find("input[data-uploaded-file]"),u=r.attr("data-uploaded-file"),f={carId:i.prev("textarea").attr("data-carid"),toID:e.UAE,note:i.prev("textarea").val(),file:u?u:"",isSelf:!1},o=function(){i.prev("textarea").val("");r.attr("data-uploaded-file","");i.closest("form").find(".ace-file-input .remove").trigger("click")},s=function(n){var f=commonManger.comp2json(n.d),t=f.list,r,u;t?(r=i.closest("form").prev(".dialogs"),u='<div class="itemdiv dialogdiv"> <div class="user"> <img alt="'+t.AuthorName+'" src="/'+t.Photo+'"> <\/div> <div class="body"> <div class="time"> <i class="icon-time"><\/i> <span class="grey">'+moment(t.AddDate).format("DD-MM-YYYY")+'<\/span> <\/div> <div class="name"> <a>'+t.AuthorName+'<\/a> <\/div> <div class="text">'+t.Notes+(t.FileUrl?' <a href="/public/notes/'+t.FileUrl+'" target="_blank" title="Download Attachment" class="green"><i class="icon-paper-clip green bigger-120"><\/i><\/a>':"")+"<\/div> <\/div> <\/div>",r.append(u),o()):(alert("Please reload the web page to review your login, Thanks"),window.location.reload())};f.note!=""?dataService.callAjax("Post",JSON.stringify(f),n+"ReplyNote",s,commonManger.errorException):(i.prev("input").focus(),commonManger.showMessage("Required fields:","Please enter your note first."))});$("#NewCarNotesCount").click(function(n){n.preventDefault();var t=$(this).text()*1;t>0&&(w(),$("#notifications").modal("show"))});$("#notifications .close").click(function(n){n.preventDefault();l()})},l=function(){var t=function(n){var r=commonManger.comp2json(n.d),t=r.list,i="NewCarNotesCount";t&&t.NewNotes*1>0?$("#"+i).text(t.NewNotes).closest("div.alert-warning").removeClass("hidden"):$("#"+i).removeAttr("id").removeAttr("href").text(0)};dataService.callAjax("Post",{},n+"GetNoteNotifications",t,commonManger.errorException)},w=function(){var t=function(n){var i=commonManger.comp2json(n.d),u=i.list,t=i.list1,r;t=$.isArray(t)?t:$.makeArray(t);r=$(u).map(function(n,i){var r=$.grep(t,function(n){return n.CarID===i.CarID}),u=$(r).map(function(n,t){return'<div class="itemdiv dialogdiv"> <div class="user"> <img alt="'+t.AuthorName+'" src="/'+t.Photo+'"> <\/div> <div class="body"> <div class="time"> <i class="icon-time"><\/i> <span class="grey">'+moment(t.AddDate).format("DD-MM-YYYY")+'<\/span> <\/div> <div class="name"> <a>'+t.AuthorName+'<\/a> <\/div> <div class="text">'+t.Notes+(t.FileUrl?' <a href="/public/notes/'+t.FileUrl+'" target="_blank" title="Download Attachment" class="green"><i class="icon-paper-clip green bigger-120"><\/i><\/a>':"")+"<\/div> <\/div> <\/div>"}).get();return'<div dir="ltr" class="widget-box"> <div class="widget-header header-color-blue5"> <h6 class="smaller"> <i class="icon-car"><\/i> <strong>'+i.Year+" "+i.MakerNameEn+" - "+i.TypeNameEn+"<\/strong>, Lot: "+i.LotNo+", "+i.ShipCompanyNameEn+", "+i.AuctionName+'<\/h6> <\/div> <div class="widget-body"> <div class="widget-main no-padding"> <div class="slimScrollDiv"><div class="dialogs">'+u.join("")+'<\/div> <form> <div class="form-actions input-append"><input id="AttachFile_'+i.CarID+'" type="file" data-uploaded-file="" class="attachment-img attchFile" /> <textarea data-carid="'+i.CarID+'" placeholder="Type your message here ..." class="width-75" name="message"><\/textarea> <button class="btn btn-app btn-info btn-mini fastReply"> <i class="icon-share-alt"><\/i> Reply<\/button> <\/div> <\/form> <\/div> <\/div> <\/div><\/div>'}).get();$(".notes-body-contents").html(r);$("#notifications .modal-body .attachment-img").ace_file_input({style:"well",btn_choose:"Attch",btn_change:null,droppable:!0,no_icon:"icon-cloud-upload",thumbnail:"small",allowExt:["jpeg","jpg","png","gif","pdf"],whitelist:"gif|png|jpg|jpeg|pdf",allowMime:["image/jpg","image/jpeg","image/png","image/gif","application/pdf"],before_remove:function(){return!0},before_change:function(n){var t=n[0],i,r;if(typeof t=="string"){if(!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t))return!1}else if((i=$.trim(t.type),i.length>0&&!/^(image|application)\/(jpe?g|png|gif|bmp|pdf)$/i.test(i)||i.length==0&&!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t.name))||t.size>1e7)return!1;return r=$(this),a(t,r),!0},preview_error:function(){}}).on("change",function(){}).on("file.error.ace",function(n,t){(t.error_count.ext||t.error_count.mime)&&alert("Invalid file type! Please select an image!");t.error_count.size&&alert("Invalid file size! Maximum 100KB")})};dataService.callAjax("Post",{},n+"GetNotificationsNotes",t,commonManger.errorException)},b=function(){$(".attachment-img").ace_file_input({style:"well",btn_choose:"Attch",btn_change:null,droppable:!0,no_icon:"icon-cloud-upload",thumbnail:"small",before_remove:function(){return!0},before_change:function(n){var t=n[0],i,r;if(typeof t=="string"){if(!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t))return!1}else if((i=$.trim(t.type),i.length>0&&!/^(image|application)\/(jpe?g|png|gif|bmp|pdf)$/i.test(i)||i.length==0&&!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t.name))||t.size>1e7)return!1;return r=$(this),a(t,r),!0}}).on("change",function(){})},a=function(n,t){var i=new FormData,r=function(n){t.attr("data-uploaded-file",n)};n&&(i.append(n.name,n),$.ajax({type:"POST",url:"/photo/AttachFile.ashx",data:i,cache:!1,contentType:!1,processData:!1,success:r,error:commonManger.errorException}))},k=function(n,t){$("span[data-carID="+t+"]").text(n)},d=function(){$("#listItems").DataTable().draw()},g=function(){var n=$("#listItems").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"Export Excel"},{extend:"copy",text:"Copy"},{text:"Print",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],bServerSide:!0,stateSave:!0,bRetrieve:!1,bDestroy:!0,sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(n){n.push({name:"funName",value:"CarsData_Search4Notes"},{name:"names",value:"chassis~Shipper~LateTitle~Buyer~Title"},{name:"values",value:i+"~"+r+"~"+u+"~"+t+"~"+f})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i)},commonManger.errorException)},drawCallback:function(){var n=this.api(),i=n.rows({page:"current"}).nodes(),t=null;n.column(0,{page:"current"}).data().each(function(n,r){t!==n&&($(i).eq(r).before('<tr class="alert alert-success"><td colspan="100%"><strong>Shipper: <\/strong>'+n+"<\/td><\/tr>"),t=n)})},iDisplayLength:50,aaSorting:[],aoColumns:[{mData:function(n){return n.ShipCompanyNameEn?n.ShipCompanyNameEn:""},bVisible:!1,bSortable:!1},{mDataProp:"CarID",sClass:"text-center",bSortable:!0},{mDataProp:"MainPicture",bSortable:!1,sClass:"text-center hidden-phone hidden-480",mData:function(n){return n.MainPicture!=null?'<img alt="car" src="/public/cars/'+n.CarID+"/_thumb/"+n.MainPicture+'" />':'<img alt="car" src="/public/cars/noimage.gif" />'}},{mDataProp:"InvoiceDate",bSortable:!0,sClass:"hidden-phone hidden-480",mData:function(n){return commonManger.formatJSONDateCal(n.InvoiceDate)}},{mDataProp:null,bSortable:!1,mData:function(n){return n.MakerNameEn+" - "+n.TypeNameEn+" - "+n.Year}},{mDataProp:"LotNo",sClass:"hidden-phone",bSortable:!1},{mDataProp:"ChassisNo",sClass:"hidden-phone hidden-480",bSortable:!1},{mDataProp:"RegionEn",mData:function(n){return n.RegionEn?n.RegionEn:""},bSortable:!1},{mDataProp:"BuyerName",sClass:"hidden-phone",bSortable:!1,mData:function(n){return n.BuyerName?n.BuyerName:""}},{mDataProp:"DistinationNameEn",bSortable:!1,mData:function(n){return'<img src="/App_Themes/iraq/images/'+n.DistinationNameEn+'.jpg" width="25" /> '+n.DistinationNameEn}},{mDataProp:"CarTitleAmrica",sClass:"text-center",bSortable:!1,mData:function(n){return n.Boocked?"":n.ShipperID==="14"?n.CarTitleAmrica==="true"?'<input type="checkbox" class="title" style="opacity:1;" checked />':'<input type="checkbox" class="title" style="opacity:1;" />':n.CarTitleAmrica==="true"?'<i title="Received title" class="green icon-ok"><\/i>':'<i title="Not received title" class="red icon-remove"><\/i>'}},{mDataProp:"Notes",sClass:"hidden-print",bSortable:!1,mData:function(n){return'<a data-car-id="'+n.CarID+'" class="btn btn-app btn-primary no-radius notes" data-rel="tooltip" data-placement="top" title="عرض التعليقات">Notes<span data-carID='+n.CarID+' class="badge badge-warning badge-right">'+n.NotesCount+"<\/span><\/a>"}}]});$("#listItems tbody").delegate("tr a","click",function(t){var i,u,r;if(t.preventDefault(),i=$(this),u=i.closest("tr"),u!==null&&(r=n.row(u).data(),i.hasClass("notes"))){var e=r.MakerNameEn+" - "+r.TypeNameEn+" - "+r.Year,f=i.attr("data-car-id"),o="Notes: "+e;$("#CarID").val(f);f&&v(f);commonManger.showPopUpDialog(o,"","commentsModal")}});$("#listItems tbody").delegate("tr :checkbox","change",function(t){var i,r,f;if(t.preventDefault(),i=$(this),r=i.closest("tr"),r!==null&&(f=n.row(r).data(),i.hasClass("title"))){var e=$(this).closest("tr").find("td:eq(0)").text(),u=i.is(":checked")?!0:!1,o=[e,u],s=mainServiceUrl+"saveDefaultData",h={values:o,actionName:"CarsData_SetTitle",Parm_names:["CarID","CarTitle"]},c=JSON.stringify(h);dataService.callAjax("Post",c,s,function(n){n.d.Status&&(u?commonManger.showMessage("Title saved:","Title has been received."):commonManger.showMessage("Title saved:","Title receiving has been canceled."))},commonManger.errorException)}})},v=function(t){var i={actionName:"CarNotes_List",id:t},r=n+"GetNotes",u=function(n){var u=commonManger.comp2json(n.d),i=u.list,f=u.list1,r=$(f).map(function(n,t){return'<div class="item"><div class="image"><img src="/'+t.Photo+'" class="img-thumbnail"><\/div><div class="date"><i class="icon-time"><\/i> '+moment(t.AddDate).format("DD-MM-YYYY")+'<\/div><div class="text"><a>'+t.AuthorName+'<\/a><p><i class="icon-quote-left"><\/i> '+t.Notes+(t.FileUrl?' <a href="/public/notes/'+t.FileUrl+'" target="_blank" title="Download Attachment" class="green"><i class="icon-paper-clip green bigger-120"><\/i><\/a>':"")+"<\/p><\/div><\/div>"}).get(),e=function(n){$("div.block.messaging").html(n)};i&&($(".car-inv-date").text(moment(i.InvoiceDate).format("DD-MM-YYYY")),$(".car-shipper").text(i.ShipCompanyNameEn),$(".car-auction").text(i.AuctionName),$(".car-region").text(i.RegionEn),$(".car-lot").text(i.LotNo),$(".car-vin").text(i.ChassisNo),$(".car-buyer").text(i.BuyerName));$.when(e(r)).then(function(){var n="#commentsModal .modal-body";$(n).scrollTop($(n)[0].scrollHeight)});r.length&&k(r.length,t)};dataService.callAjax("Post",JSON.stringify(i),r,u,commonManger.errorException)};return{Init:y}}();