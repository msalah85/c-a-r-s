var pageManager=function(){var d="",u="",i="",f="",t="",r="",e="",o={UAE:1,USA:2},s="frmAddNote",h="pnlReply",c=function(){$(".modal-footer textarea,.modal-footer input,.modal-footer select").val("");$(".ace-file-input .remove").trigger("click");$("#attchFile").attr("data-uploaded-file","");$("#frmAddNote .self-msg").attr("checked",!1)},l=function(){$("#"+s).addClass("hidden");$("#"+h).removeClass("hidden")},n="america/carnotes.aspx/",g=function(){var n=commonManger.getUrlVars();t=n.latedays;t=t?t:"";n.latetitle&&n.latetitle!==""&&(r=1,$("#CarTitleAmrica").attr("checked",!0));et();ut();v();nt();it()},nt=function(){$("#shipper").change(function(){i=$(this).val();b()});$("#btnSearchAll").click(function(n){n.preventDefault();w();d=$("#Buyer").val();u=$("#ChassisN").val();i=$("#shipper").val();f=$("#DistinationID").val();r=$("#CarTitleAmrica").is(":checked")?1:"";e=$('[name="Title"]:checked').val()?$('[name="Title"]:checked').val():"";b()});$(".bookingUndo").click(function(n){n.preventDefault();w()});$("#startReply").click(function(n){n.preventDefault();$("#"+s).removeClass("hidden");$("#"+h).addClass("hidden")});$("#btnCancelRepaying").click(function(n){n.preventDefault();l();c()});$("#bntSendNote").click(function(n){n.preventDefault();a()});$("textarea#txtNote").bind("keydown","return",function(n){n.preventDefault();a()});$(".notes-body-contents").delegate("button.fastReply","click",function(t){t.preventDefault();var r=$(this),i=r.closest(".btn-group"),u=i.closest("div.form-panel").find("input").attr("data-uploaded-file"),f={carId:i.prev("textarea").attr("data-carid"),toID:o.USA,note:i.prev("textarea").val(),file:u?u:"",isSelf:!1},e=function(){i.prev("textarea").val("");i.closest("div.form-panel").find("input").attr("data-uploaded-file","");i.closest("div.form-panel").find("a.remove").trigger("click")},s=function(n){var f=commonManger.comp2json(n.d),t=f.list,i,u;t?(i=r.closest("form").prev(".dialogs"),u='<div class="itemdiv dialogdiv"> <div class="user"> <img alt="'+t.AuthorName+'" src="/'+t.Photo+'"> <\/div> <div class="body"> <div class="time"> <i class="icon-time"><\/i> <span class="grey">'+moment(t.AddDate).format("DD-MM-YYYY")+'<\/span> <\/div> <div class="name"> <a>'+t.AuthorName+'<\/a> <\/div> <div class="text">'+t.Notes+(t.FileUrl?' <a href="/public/notes/'+t.FileUrl+'" target="_blank" title="Download Attachment" class="green"><i class="icon-paper-clip green bigger-120"><\/i><\/a>':"")+"<\/div> <\/div> <\/div>",i.append(u),e()):(alert("Please reload the web page to review your login, Thanks"),window.location.reload())};f.note!=""?dataService.callAjax("Post",JSON.stringify(f),n+"ReplyNote",s,commonManger.errorException):(i.prev("textarea").focus(),commonManger.showMessage("Required fields:","Please enter your note first."))});$(".notes-body-contents").delegate("button.closeNote","click",function(n){var t,i,r;n.preventDefault();t=$(this);i=t.attr("data-carid");i!=""&&(r=p(i),t.closest(".widget-box").remove())});$("#commentsModal .modal-footer .closeNote").click(function(n){n.preventDefault();var t=$("#CarID").val();t&&(p(t),$("#commentsModal").modal("hide"))});$("#NewCarNotesCount").click(function(n){n.preventDefault();tt();$("#notifications").modal("show")});$("#notifications .close").click(function(n){n.preventDefault();v()})},a=function(){var t={carId:$("#CarID").val(),toID:o.USA,note:$("#txtNote").val(),isSelf:$("#frmAddNote .self-msg").is(":checked")?!0:!1,file:$("#attchFile").attr("data-uploaded-file")?$("#attchFile").attr("data-uploaded-file"):""},i=function(n){n.d?(c(),l(),k(t.carId)):(alert("Please reload the web page to review your login, Thanks"),window.location.reload())};t.note!=""?dataService.callAjax("Post",JSON.stringify(t),n+"ReplyNote",i,commonManger.errorException):($("#txtNote").focus(),commonManger.showMessage("Required fields:","Please enter your note first."))},v=function(){var t=function(n){var i=commonManger.comp2json(n.d),t=i.list;t&&t.NewNotes*1>0&&$("#NewCarNotesCount").text(t.NewNotes).closest("div.alert-warning").removeClass("hidden")};dataService.callAjax("Post",{},n+"GetNoteNotifications",t,commonManger.errorException)},tt=function(){var t=function(n){var i=commonManger.comp2json(n.d),u=i.list,t=i.list1,r;t=$.isArray(t)?t:$.makeArray(t);r=$(u).map(function(n,i){var r=$.grep(t,function(n){return n.CarID===i.CarID}),u=$(r).map(function(n,t){return'<div class="itemdiv dialogdiv"> <div class="user"> <img alt="'+t.AuthorName+'" src="/'+t.Photo+'"> <\/div> <div class="body"> <div class="time"> <i class="icon-time"><\/i> <span class="grey">'+moment(t.AddDate).format("DD-MM-YYYY")+'<\/span> <\/div> <div class="name"> <a>'+t.AuthorName+'<\/a> <\/div> <div class="text"><i class="icon-quote-left"><\/i> '+t.Notes+(t.FileUrl?' <a href="/public/notes/'+t.FileUrl+'" target="_blank" title="Download Attachment" class="green"><i class="icon-paper-clip green bigger-120"><\/i><\/a>':"")+"<\/div> <\/div> <\/div>"}).get();return'<div dir="ltr" class="widget-box"> <div class="widget-header header-color-blue5"> <h6 class="smaller"> <i class="icon-car"><\/i> '+i.Year+" "+i.MakerNameEn+" - "+i.TypeNameEn+", Lot: "+i.LotNo+", "+i.ShipCompanyNameEn+", "+i.AuctionName+'<\/h6> <\/div> <div class="widget-body"> <div class="widget-main no-padding"> <div class="slimScrollDiv"><div class="dialogs">'+u.join("")+'<\/div> <form> <div class="form-panel"><input id="AttachFile_'+i.CarID+'" type="file" data-uploaded-file="" class="attachment-img attchFile" /> <textarea class="width-75 fast-reply-text" data-carid="'+i.CarID+'" placeholder="Type your message here ..." name="message"><\/textarea> <div class="btn-group btn-group-vertical pull-right"><button class="btn btn-small btn-info no-radius fastReply"> <i class="icon-share-alt"><\/i> Reply&nbsp;<\/button> <button class="btn btn-small btn-danger no-radius closeNote" data-carid="'+i.CarID+'">Close note<\/button><\/div><\/div> <\/form> <\/div> <\/div> <\/div><\/div>'}).get();$(".notes-body-contents").html(r);$("#notifications .modal-body .attachment-img").ace_file_input({style:"well",btn_choose:"Attch",btn_change:null,droppable:!0,no_icon:"icon-cloud-upload",thumbnail:"small",allowExt:["jpeg","jpg","png","gif","pdf"],whitelist:"gif|png|jpg|jpeg|pdf",allowMime:["image/jpg","image/jpeg","image/png","image/gif","application/pdf"],before_remove:function(){return!0},before_change:function(n){var t=n[0],i,r;if(typeof t=="string"){if(!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t))return!1}else if((i=$.trim(t.type),i.length>0&&!/^(image|application)\/(jpe?g|png|gif|bmp|pdf)$/i.test(i)||i.length==0&&!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t.name))||t.size>1e7)return!1;return r=$(this),y(t,r),!0},preview_error:function(){}}).on("change",function(){}).on("file.error.ace",function(n,t){(t.error_count.ext||t.error_count.mime)&&alert("Invalid file type! Please select an image!");t.error_count.size&&alert("Invalid file size! Maximum 100KB")})};dataService.callAjax("Post",{},n+"GetNotificationsNotes",t,commonManger.errorException)},it=function(){$(".attachment-img").ace_file_input({style:"well",btn_choose:"Attch",btn_change:null,droppable:!0,no_icon:"icon-cloud-upload",thumbnail:"small",allowExt:["jpeg","jpg","png","gif","pdf"],whitelist:"gif|png|jpg|jpeg|pdf",allowMime:["image/jpg","image/jpeg","image/png","image/gif","application/pdf"],before_remove:function(){return!0},before_change:function(n){var t=n[0],i,r;if(typeof t=="string"){if(!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t))return!1}else if((i=$.trim(t.type),i.length>0&&!/^(image|application)\/(jpe?g|png|gif|bmp|pdf)$/i.test(i)||i.length==0&&!/\.(jpe?g|png|gif|bmp|pdf)$/i.test(t.name))||t.size>1e7)return!1;return r=$(this),y(t,r),!0},preview_error:function(){}}).on("change",function(){}).on("file.error.ace",function(n,t){(t.error_count.ext||t.error_count.mime)&&alert("Invalid file type! Please select an image!");t.error_count.size&&alert("Invalid file size! Maximum 100KB")}).on("file.error.ace",function(n,t){(t.error_count.ext||t.error_count.mime)&&alert("Invalid file type! Please select an image!");t.error_count.size&&alert("Invalid file size! Maximum 100KB")})},y=function(n,t){var i=new FormData,r=function(n){t.attr("data-uploaded-file",n)};n&&(i.append(n.name,n),$.ajax({type:"POST",url:"/photo/AttachFile.ashx",data:i,cache:!1,contentType:!1,processData:!1,success:r,error:commonManger.errorException}))},p=function(t){var i={carid:t},r=function(n){if(n.d*1>0)return commonManger.showMessage("Note Closed","Notes on this car has been closed successfully."),n.d*1;commonManger.showMessage("Not found:","There are no notes to be closed.")};dataService.callAjax("Post",JSON.stringify(i),n+"CloseNote",r,commonManger.errorException)},w=function(){$(".bookingNow .badge-pink").text("0");$(".bookingNow,.bookingUndo").addClass("hidden");$("input[name$=ToCheck]").val("");var n=$("input[name=CarID]:checked").map(function(){return $(this).attr("checked",!1),this.value})},rt=function(n){var t=$("input[name=shipperToCheck]"),i=$("input[name=distToCheck]"),u=n.attr("data-shipper"),f=n.attr("data-distination"),r;if(t.val()!==""&&i.val()!==""){if(t.val()!==u||i.val()!==f){commonManger.showMessage("خطأ بالاختيار","برجاء اختيار السيارات التابعة لشاحن واحد وجهة وصول واحدة.");n.removeAttr("checked");return}}else t.val(u),i.val(f);r=$("input[name=CarID]:checked").map(function(){return this.value}).get().join(",");$(".bookingNow").attr("href","bookingbol.aspx?ids="+r);$(".select:checked").is(":checked")?$(".bookingNow,.bookingUndo").removeClass("hidden"):($(".bookingNow,.bookingUndo").addClass("hidden"),$("input[name$=ToCheck]").val(""));$(".bookingNow .badge-pink").text(r.split(",").length)},ut=function(){dataService.callAjax("Post",JSON.stringify({actionName:"CarsData_ShippCompanies",value:""}),mainServiceUrl+"GetData",function(n){var t=JSON.parse(n.d);commonManger.Filllist(t,"masterForm")},commonManger.errorException)},ft=function(n,t){$("span[data-carID="+t+"]").text(n)},b=function(){$("#listItems").DataTable().draw()},et=function(){var n=$("#listItems").DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BT>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{extend:"copy",text:"نسـخ"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],bServerSide:!0,responsive:!0,bRetrieve:!1,bDestroy:!0,sAjaxSource:sUrl+"LoadDataTablesXML",fnServerParams:function(n){n.push({name:"funName",value:"CarsData_Search4Notes"},{name:"names",value:"chassis~Shipper~Dist~LateTitle~LateDays~Title"},{name:"values",value:u+"~"+i+"~"+f+"~"+r+"~"+t+"~"+e})},fnServerData:function(n,t,i){dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i)},commonManger.errorException)},drawCallback:function(){var n=this.api(),i=n.rows({page:"current"}).nodes(),t=null;n.column(0,{page:"current"}).data().each(function(n,r){t!==n&&($(i).eq(r).before('<tr class="alert alert-success"><td colspan="100%"><strong>الشاحن: <\/strong>'+n+"<\/td><\/tr>"),t=n)})},iDisplayLength:50,aaSorting:[],aoColumns:[{mData:function(n){return n.ShipCompanyNameEn?n.ShipCompanyNameEn:""},bVisible:!1,bSortable:!1},{mDataProp:"CarID",sClass:"text-center",bSortable:!0},{mDataProp:"MainPicture",bSortable:!1,sClass:"text-center hidden-phone hidden-480",mData:function(n){return n.MainPicture!=null?'<img alt="car" src="/public/cars/'+n.CarID+"/_thumb/"+n.MainPicture+'" />':'<img alt="car" src="/public/cars/noimage.gif" />'}},{mDataProp:"InvoiceDate",bSortable:!0,sClass:"hidden-phone hidden-480",mData:function(n){return commonManger.formatJSONDateCal(n.InvoiceDate)}},{mDataProp:null,bSortable:!1,mData:function(n){return n.MakerNameEn+" - "+n.TypeNameEn+" - "+n.Year}},{mDataProp:"full_name",bSortable:!1,mData:function(n){return n.SaleClientName?n.SaleClientName:n.full_name}},{mDataProp:"LotNo",sClass:"hidden-phone",bSortable:!1},{mDataProp:"ChassisNo",sClass:"hidden-phone hidden-480",bSortable:!1},{mDataProp:"RegionEn",mData:function(n){return n.RegionEn?n.RegionEn:""},bSortable:!1},{mDataProp:"BuyerName",sClass:"hidden-phone",bSortable:!1,mData:function(n){return n.BuyerName?n.BuyerName:""}},{mDataProp:"DistinationNameEn",bSortable:!1,mData:function(n){return'<img src="/App_Themes/iraq/images/'+n.DistinationNameEn+'.jpg" width="25" /> '+n.DistinationNameEn}},{mDataProp:"CarTitleAmrica",sClass:"text-center",bSortable:!1,mData:function(n){return n.Boocked?"":n.CarTitleAmrica==="true"?'<input type="checkbox" class="title" style="opacity:1;" checked />':'<input type="checkbox" class="title" style="opacity:1;" />'}},{bSortable:!1,sClass:"text-center hidden-print",mData:function(n){return n.Boocked?"":n.CarTitleAmrica==="true"?'<input type="checkbox" class="select" data-shipper="'+n.ShipperID+'" data-distination="'+n.DistinationID+'" name="CarID" value="'+n.CarID+'" style="opacity:1;" />':'<input type="checkbox" class="select" disabled data-shipper="'+n.ShipperID+'" data-distination="'+n.DistinationID+'" name="CarID" value="'+n.CarID+'" />'}},{mDataProp:"Notes",sClass:"hidden-print",bSortable:!1,mData:function(n){return'<a data-car-id="'+n.CarID+'" class="btn btn-app btn-primary no-radius notes" data-rel="tooltip" data-placement="top" title="عرض التعليقات">Notes<span data-carID='+n.CarID+' class="badge badge-warning badge-right">'+n.NotesCount+"<\/span><\/a>"}}]});$("#listItems tbody").delegate("tr a","click",function(t){var i,u,r;if(t.preventDefault(),i=$(this),u=i.closest("tr"),u!==null&&(r=n.row(u).data(),i.hasClass("notes"))){var e=r.MakerNameEn+" - "+r.TypeNameEn+" - "+r.Year,f=i.attr("data-car-id"),o="Notes: "+e;$("#CarID").val(f);f&&k(f);commonManger.showPopUpDialog(o,"","commentsModal")}});$("#listItems tbody").delegate("tr :checkbox","change",function(t){var i,r,f;if(t.preventDefault(),i=$(this),r=i.closest("tr"),r!==null)if(f=n.row(r).data(),i.hasClass("title")){var e=$(this).closest("tr").find("td:eq(0)").text(),u=i.is(":checked")?!0:!1,o=[e,u],s=mainServiceUrl+"saveDefaultData",h={values:o,actionName:"CarsData_SetTitle",Parm_names:["CarID","CarTitle"]},c=JSON.stringify(h);dataService.callAjax("Post",c,s,function(n){n.d.Status&&(u?(commonManger.showMessage("تم الحفظ بنجاح","تم حفظ وصول ورق (تايتل - Title) السيارة بنجاح."),i.closest("tr").find(".select:checkbox").removeAttr("disabled").css("opacity","1")):(commonManger.showMessage("تم الحفظ بنجاح","تم إلغاء وصول ورق (تايتل - Title) السيارة بنجاح."),i.closest("tr").find(".select:checkbox").attr("disabled",!0).attr("checked",!1).css("opacity","0")))},commonManger.errorException)}else i.hasClass("select")&&rt(i)})},k=function(t){var i={actionName:"CarNotes_List",id:t},r=n+"GetNotes",u=function(n){var u=commonManger.comp2json(n.d),i=u.list,f=u.list1,r=$(f).map(function(n,t){return'<div class="item"><div class="image"><img src="/'+t.Photo+'" class="img-thumbnail"><\/div><div class="date"><i class="icon-time"><\/i> '+moment(t.AddDate).format("DD-MM-YYYY")+'<\/div><div class="text"><a>'+t.AuthorName+'<\/a><p><i class="icon-quote-left"><\/i> '+t.Notes+(t.FileUrl?' <a href="/public/notes/'+t.FileUrl+'" target="_blank" title="Download Attachment" class="green"><i class="icon-paper-clip green bigger-120"><\/i><\/a>':"")+"<\/p><\/div><\/div>"}).get(),e=function(n){$("div.block.messaging").html(n)};i&&($(".car-inv-date").text(moment(i.InvoiceDate).format("DD-MM-YYYY")),$(".car-shipper").text(i.ShipCompanyNameEn),$(".car-auction").text(i.AuctionName),$(".car-region").text(i.RegionEn),$(".car-lot").text(i.LotNo),$(".car-vin").text(i.ChassisNo),$(".car-buyer").text(i.BuyerName));$.when(e(r)).then(function(){var n="#commentsModal .modal-body";$(n).scrollTop($(n)[0].scrollHeight)});r.length&&ft(r.length,t)};dataService.callAjax("Post",JSON.stringify(i),r,u,commonManger.errorException)};return{Init:g}}();