jQuery.fn.dataTable.Api.register("sum()",function(){function n(n){return/^<.*?>$/.test(n)&&!!$(n)[0]}return this.flatten().reduce(function(t,i){return typeof t=="string"&&(n(t)&&(t=$(t).text()),t=t.replace(/[^\d.-]/g,"")*1),typeof i=="string"&&(n(i)&&(i=$(i).text()),i=i.replace(/[^\d.-]/g,"")*1),t+i},0)});var continerId="",CustomsInvoicesManager=function(){var u=$("select[id$=CustomsCompanyID]"),n=$("select[id$=ContainerNo]"),r=null,t=null,f=function(){return $("#DistinationID").val()==="2"?3.67:3.667},s=function(){$.fn.afterSave=function(){o();i();window.setTimeout(i,3e3)};$("#ExpenseTypeID").on("change",function(){var n=$(this).val();n!=""?(n=n.split("|"),$("#CustomsExpenseValue").val(n[1]).attr("data-val",n[1])):$("#CustomsExpenseValue").val()});$("button.btnAddExpens").on("click",function(n){var u,s;if(n.preventDefault(),a()){var f=$("#CustomsExpenseValue").val(),h=$("#CustomsExpenseValue").attr("data-val"),r=$("#ExpenseTypeID").val().split("|"),t={id:r[0],no:r[3],total:parseFloat(f)*parseInt(r[3]),expValue:parseFloat(f),expValueToValid:parseFloat(h),name:$("#ExpenseTypeID option:selected").text(),del:'<button class="btn btn-mini btn-danger remove"><i class="icon-remove"><\/i><\/button>'},e=$("#listItems2").DataTable(),o='<a data-index="'+t.id+'" href="#CustomExpenseModal" data-toggle="modal" class="btn btn-mini btn-info edit"><i class="icon-edit"><\/i><\/a> ';t.expValue>t.expValueToValid?commonManger.showMessage("برجاء التحقق من قيمة المصروف","برجاء ادخال قيمة مصروف أقل من أو تساوى القيمة الافتراضية."):(c(t.id)?(u=[t.id,t.name,t.expValue,t.no,t.total,o+t.del],s=$("#listItems2 a[data-index="+t.id+"]").closest("tr"),$(u).each(function(n){(n==2||n==4)&&e.cell(s,n).data(numeral(u[n]).format("0.00")).draw()}),commonManger.showMessage("تم تحديث البيانات","تم تحديث المصروف بنجاح.")):(e.row.add([t.id,t.name,t.expValue,t.no,t.total,o+t.del]).draw(!1),commonManger.showMessage("تم الحفظ","تم حفظ المصروف بنجاح.")),$("#CustomExpenseModal").modal("hide"),i())}});$("button.btnFinish").on("click",function(n){var t=$(n.target);if($(this).preventDoubleClick(),n.preventDefault(),(!t.data("lockedAt")||+new Date-t.data("lockedAt")>300)&&(checkMe=l("masterForm"),checkMe)){var r=$("#CustomsInvoiceID").val(),i=[];$("#listItems2 tbody").find("tr").each(function(){var n="0,"+r+",";$(this).find("td:not(:eq(1))").each(function(){n+=$(this).text()+","});n.indexOf(",,")>=0&&(n=n.substring(0,n.length-2));n.indexOf("عفواً")>=0&&(n="0,0,0,0,0,0");i.push(n)});h("masterForm",["CustomsDetailsID","CustomsInvoiceID","ExpenseTypeID","CustomsExpenseValue","CarsNo","TotalExpensesValue"],i,"CustomsInvoices_Save")}t.data("lockedAt",+new Date)});$("input[name=CustomVal]").on("keyup change blur",function(){var n=$(this).val(),t=$("#CustomsPrice"),i;n!==""?(n=parseFloat(n),i=n/3.693/4,t.val(i.toFixed(2))):t.val(0)});$("#listItems2 tbody").delegate("tr a.edit","click",function(n){var r,i,u,f;n.preventDefault();r=$(this);i=r.closest("tr");i!==null&&(u=t.row(i).data(),f=$('#ExpenseTypeID option:contains("'+u[1]+'")').val(),$("#ExpenseTypeID").val(f).change())});$("#listItems2 tbody").delegate("tr button.remove","click",function(n){n.preventDefault();var u=$(this),r=u.closest("tr");r!==null&&DeleteConfirmation(function(){t.row(r).remove().draw();i();commonManger.showMessage("تم الحذف","تمت عملية الحذف بنجاح.")})});u.change(function(){var t=$(this).val(),i,r;t!==""?(i=mainServiceUrl+"GetData",r={actionName:"CustomInvoices_FilterContainers",value:t},dataService.callAjax("Post",JSON.stringify(r),i,CustomsInvoicesManager.BindContainers,commonManger.errorException)):(n.empty().append("<option><\/option>"),n.chosen().trigger("chosen:updated").trigger("liszt:updated"))});u.find(".search-choice-close").click(function(){n.empty().append("<option><\/option>");n.chosen().trigger("chosen:updated").trigger("liszt:updated")});$(".contNo, input[name=CustomVal]").on("change",function(){$("#ContainerNo").val()!==null&&$("#ContainerNo").val()!==""&&$("#CustomsPrice").val()!=="0"&&e()})},h=function(n,t,i,r){var u=[],e=[],h=commonManger.Returncontrolsval(n),c;e=h[0];e.push("TotalCustoms","TotalExpenses","TotalAmount","TotalCustomsDhs","TotalExpensesDhs","TotalAmountDhs");u=h[1];var o=parseFloat($("#lblCustomTotal").text()),s=parseFloat($("#lblTotalExpenses").text()),l=parseFloat($("#lblInvoiceTotal").text());u.push(o,s,l,o*3.693,s*f(),o*3.693+s*f());c={values:u,actionName:r,Parm_names:e,fieldsDetails:t,valuesDetails:i,flage:"1"};dataService.callAjax("Post",JSON.stringify(c),mainServiceUrl+"SaveDataMasterDetails",function(n){commonManger.showMessage("تم الحفظ بنجاح:",n.d.message);window.location.href="InvoicesCustomsView.aspx"},commonManger.errorException)},c=function(n){var t=!1;return $("#listItems2 tbody tr").each(function(){$(this).find("td:eq(0)").each(function(){$(this).text()===n&&(t=!0)})}),t},l=function(n){var t=!0;return $("#"+n+" .required").each(function(){$(this).val()===""&&(t=!1)}),t},i=function(){var i=0,n=0,u;$('a[data-name="CustomsOnCar"]').each(function(){n+=$(this).text()*1});n===0&&(n=r.column(3).data().sum());i=t?t.column(4).data().sum():0;n=n.toFixed(2);i=i.toFixed(2);$("#lblCustomTotal").text(numeral(n).format("0.00"));$("#lblTotalExpenses").text(numeral(i).format("0.00"));u=n*1+i*1;$("#lblInvoiceTotal").text(numeral(u).format("0.00"));$("#lblInvoiceTotalDhs").text(numeral(n*3.693+i*f()).format("0"))},a=function(){var n=$("#ExpenseTypeID option:selected").val(),t=$("#CustomsExpenseValue").val();if(n!==undefined&&n!==""&&t!==""&&t>0)return!0;$("#CustomsExpenseValue").focus()},v=function(n,t){var i=$("<option />").val(n.ExpenseTypeID+"|"+n.ExpensesCharge+"|"+t+"|"+n.CarsNo).text(n.ExpenseTypeNameAr);$("#ExpenseTypeID").append(i)},y=function(n){var c=LZString.decompressFromUTF16(n.d),e=$.parseXML(c),o=$.xml2json(e).list,s=$.xml2json(e).list1,f=[],l=0,u,h;o&&(r!==null&&$("#listItems").DataTable().destroy(),$(o).each(function(n,t){$("#DistinationID").val(t.CarDistinationID);f.push([t.MakerNameEn+" - "+t.TypeNameEn+" - "+t.Year,t.LotNo,numeral(t.PayPrice).format("0.00"),'<a title="تعديل المبلغ" data-type="text" data-id="CarID" data-pk="'+t.CarID+'" data-table="CarsData" data-name="CustomsOnCar" class="editable" href="#" data-placeholder="أدخل المبلغ">'+numeral(t.CustomCostOnCar).format("0.00")+"<\/a>"]);l+=parseFloat(t.CustomCostOnCar)}));f.length&&(r=commonManger.populateDataTable(f,"listItems"));u=[];h=0;$("#ExpenseTypeID").html("<option />");s&&(t!==null&&$("#listItems2").DataTable().destroy(),$(s).each(function(n,t){var i=parseFloat(t.ExpensesCharge)*parseInt(t.CarsNo);v(t,i);t.ExpenseTypeID!=="11"&&(u.push([t.ExpenseTypeID,t.ExpenseTypeNameAr,numeral(t.ExpensesCharge).format("0.00"),t.CarsNo,numeral(i).format("0.00"),'<a data-index="'+t.ExpenseTypeID+'" href="#CustomExpenseModal" data-toggle="modal" class="btn btn-mini btn-info edit"><i class="icon-edit"><\/i><\/a> <button class="btn btn-mini btn-danger remove"><i class="icon-remove"><\/i><\/button>']),h+=i)}));u.length>0&&(t=commonManger.populateDataTable(u,"listItems2"));i();u.length>0?$(".btnFinish,.btn-addExp").removeClass("hidden"):$(".btnFinish,.btn-addExp").addClass("hidden")},e=function(){var n=$(".contNo").val(),t=$("#CustomsPrice").val(),i=[n,t,u.val()],r={actionName:"CustomsInvoices_GetCarsWithCustoms",names:["pkId","CustomVal","CustomCoID"],values:i};n!==null&&n!==""&&dataService.callAjax("Post",JSON.stringify(r),sUrl+"GetDataList",y,commonManger.errorException)},p=function(n){var t=$("select[id$=ExpenseTypeID]");e();n!==""&&$.ajax({type:"POST",url:"InvoiceCustomsAdd.aspx/GetCustomCompExpenses",data:"{container: '"+n+"'}",contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:function(){$("#divSpinner").html("<i class='icon-spinner icon-spin orange bigger-125'><\/i>")},complete:function(){$("#divSpinner").html("")},success:function(n){var i=typeof n.d=="string"?eval("("+n.d+")"):n.d;t.empty().append('<option val="">اختر نوع المصروف<\/option>');$(i.ExpenseTypes).each(function(n,i){$("<option>",{value:i.ExpenseTypeID}).html(i.ExpenseTypeNameAr).appendTo(t)})}})},w=function(t){var i=typeof t.d=="string"?eval("("+t.d+")"):t.d;n.empty().append("<option><\/option>");$(i).each(function(t,i){$("<option>",{value:i.ID}).html(i.Name).appendTo(n)});continerId!==""&&n.val(_shipperId);n.chosen().trigger("chosen:updated").trigger("liszt:updated")},o=function(){r.draw()};return{Init:s,BindContainers:w,GetCompCustomsExpenseTypes:p,filllistItems:e,expensesGridTotal:i,updateGrid:o}}();CustomsInvoicesManager.Init();