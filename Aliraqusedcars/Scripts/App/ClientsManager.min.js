var ClientsManager=function(){var i=0,n=null,t="listItems",e="",p=function(){d();rt();g()},w=function(n){n=n.d;n.Result&&n.Result.indexOf("Successful")>0?commonManger.showMessage("تم الارسال بنجاح.","تم ارسال الرسالة بنجاح."):commonManger.showMessage("خطأ بالارسال:","لقد حدث خطأ أثناء تنفيذ العملية:"+n.Result);$(".modal").modal("hide")},b=function(n,t){t?$("#"+n).removeAttr("disabled").html('<i class="icon-save"><\/i> ارسـل رسالة'):$("#"+n).removeAttr("disabled").text("جاري الارسال ...")},o=function(){n=null;$("a.by-char").removeClass("active")},k=function(){$("#clientsTabs li").removeClass("active").last().addClass("active")},s=function(){$("#MasterID").select2("data",null);$("#aspnetForm")[0].reset();$("#ClientID").val("0");$(".client-options").removeClass("hidden")},r=function(){$("#"+t).DataTable().draw(!1)},ft=function(n){var t={valuesDetails:n};dataService.callAjax("Post",JSON.stringify(t),"Clients.aspx/SaveDataMasterDetails",function(n){n.d.Status&&($("#ClientModal").modal("hide"),commonManger.showMessage("تم الحفظ بنجاح:",n.d.Message),r())},commonManger.errorException)},h=function(n,t,i){var r={actionName:i,value:n};dataService.callAjax("Post",JSON.stringify(r),sUrl+"GetData",t,commonManger.errorException)},c=function(n){window.history.pushState("","العملاء","clients.aspx"+n)},d=function(){if(window.location.hash){var r=window.location.hash.match(/^#?(.*)$/)[1],t=r.split("=");t.length>0&&(t[0]==="t"?(i=t[1],$("#clientsTabs li").removeClass("active"),$('#clientsTabs li a[data-id="'+i+'"]').closest("li").addClass("active")):t[0]==="c"&&(n=t[1]))}else return""},g=function(){$("a.by-char").click(function(t){t.preventDefault();var i=$(this);i.hasClass("active")||(o(),n=i.addClass("active").text().replace(/\s/g,""),r(),k(),n&&c("#c="+n))});$("#clientsTabs li a").click(function(n){n.preventDefault();$(this).closest("li").hasClass("active")||(i=$(this).data("id"),o(),c("#t="+i),r())});$("a.addition").on("click",function(){s();tt();commonManger.showPopUpDialog("اضافة عميــــــل","insert","ClientModal")});$("#send-sms").click(function(n){var i,t,r,u;n.preventDefault();i=$(".mobileNo").text();t=$("#msg").val();t!=""?(r="sms-templates.aspx/SendSMS",u={phones:i,message:t},dataService.callAjax("Post",JSON.stringify(u),r,w,commonManger.errorException),b("send-sms",!0)):commonManger.showMessage("حقول مطلوبة","برجاء التأكد من إدخال  نص الرسالة.")});$(".btn-save").on("click",function(n){n.preventDefault();var u=$(this),t={ClientID:$("#ClientID").val(),full_name:$("#txtName").val(),phone:$("#txtPhone").val(),phone2:$("#phone2").val(),countryCode:$("#countryCode").val(),countryCode2:$("#countryCode2").val(),user_name:$("#txtUsername").val(),user_password:$("#txtPassword").val(),user_type:$("#user_type").val(),Notes:$("#Notes").val(),send_sms:$("#cbSMS").is(":checked")?!0:!1},i={scParam:t,masterId:$("#MasterID").val()},r=y();if(r)commonManger.doWork("ClientModal","aspnetForm","Clients.aspx/SaveClient",i,function(n){v(n.d,t)},commonManger.errorException);else return!1});var u=$("#"+t).DataTable();$(document).delegate("#"+t+" tbody tr a.show-details-btn","click",function(n){var e;n.preventDefault();var i=$(this),r=i.data("cid"),t=i.closest("tr"),u=t.nextAll('tr[data-masterid="'+r+'"]');u.hasClass("detail-row")?(t.toggleClass("master-row"),u.toggleClass("open")):(e=function(n){var i=commonManger.comp2json(n.d),r=i.list,u=$(r).map(function(n,i){var r=t.clone(!0),f,u,e;return r.removeClass("master-row odd even").addClass("detail-row open").attr("data-masterid",i.MasterID).find("td:eq(0)").html('<a data-rel="tooltip" title="سيارات العميل" href="ClientCars.aspx?id='+i.ClientID+'"><i class="icon-long-arrow-left"><\/i> '+i.full_name+"<\/a>"),r.find("td:eq(1),td:eq(2)").text(""),r.find("td:eq(3)").text(numeral(parseFloat(i.BalanceDebit)-parseFloat(i.BalanceCredit)).format("0,0")),r.find("td:eq(4)").text(numeral(i.PresentRequired).format("0,0")),f=parseFloat(i.BalanceDebit*1)-parseFloat(i.BalanceCredit*1)-i.PresentRequired*1,r.find("td:eq(5)").text(numeral(f).format("0,0")),r.find("td:eq(6)").html('<span data-rel="tooltip" title="رصيد: '+numeral(i.BalanceDebit*1-i.BalanceCredit*1).format("0,0")+" - مطلوب:"+numeral(i.TotalRequired).format("0,0")+'">'+numeral(i.BalanceDebit*1-i.BalanceCredit*1-i.TotalRequired*1).format("0,0")+"<\/span>"),u="",i.user_type==="1"&&(u='<li><a data-cid="'+i.ClientID+'" class="click contr" data-toggle="modal" data-target="#contracts" href="#contracts" title="عقود البيع">عقود البيع<\/a><\/li>'),e='<div class="btn-group"><button data-toggle="dropdown" class="btn btn-small btn-info dropdown-toggle">اخـتـر <i class="icon-angle-down icon-on-right"><\/i><\/button>                                    <ul class="dropdown-menu pull-right">                                        <li>                                            <a href="ClientCars.aspx?id='+i.ClientID+'">سيارات العميل<\/a>                                        <\/li>                                        <li>                                            <a data-cid="'+i.ClientID+'" class="edit click" data-toggle="modal" data-target="#ClientModal" href="#ClientModal">تعديل بيانات العميل<\/a>                                        <\/li>'+u+"<\/div>",r.find("td:eq(7)").html(e),$(r).insertAfter(t),r}).get();u&&(t.toggleClass("master-row"),f())},h(r,e,"Client_ChildsList"));$(this).find("i.ace-icon").toggleClass("icon-chevron-down").toggleClass("icon-chevron-up")});$(document).delegate("#"+t+" tbody tr a.click","click",function(n){var i,r,t;if(n.preventDefault(),i=$(this),r=i.closest("tr"),r!==null)if(i.hasClass("edit")){var t=u.row(r).data(),f=function(n){$("#ClientID").val(n.ClientID);n.MasterID&&($("#MasterID").select2("data",{id:n.MasterID,text:n.MasterName}),$(".client-options").addClass("hidden"));$("#txtName").val(n.full_name);$("#txtPhone").val(n.phone);$("#phone2").val(n.phone2);$("#countryCode").val($.trim(n.countryCode));$("#countryCode2").val($.trim(n.countryCode2));$("#txtUsername").val(n.user_name);$("#txtPassword").val(n.user_password);$("#Notes").val(n.Notes);$("#user_type").val(n.user_type);$("#cbSMS").attr("checked",n.send_sms=="1"?!0:!1)};if(s(),t!=null)f(t);else{var e=function(n){var i=commonManger.comp2json(n.d),t=i.list;t&&f(t)},o=i.data("cid");h(o,e,"Clients_One")}}else i.hasClass("remove")?DeleteConfirmation(function(){t=u.row(r).data();var n=t.ClientID;commonManger.deleteData("anyThing",it,commonManger.errorException,"Clients","id",n)}):i.hasClass("sms")&&(t=u.row(r).data(),document.getElementById("smsForm").reset(),$("#smsForm")[0].reset(),t!=null&&($(".mobileNo").text((t.countryCode!=null?$.trim(t.countryCode):"00971")+t.phone),$("#msg").val($("#msg").val().replace("@username",t.user_name).replace("@password",t.user_password))))});$("#MasterID").on("change",function(){var n=$(this).val();n!=""?$(".client-options").addClass("hidden"):$(".client-options").removeClass("hidden")});commonManger.searchData(u);$("input[type=text]").on("focus click",function(){$(this).select()});$("#contracts").on("hidden.bs.modal",function(){l()});$("#contracts").on("show.bs.modal",function(n){var i=$(n.relatedTarget),t=i.attr("data-cid"),r=function(n){var r=commonManger.comp2json(n.d),i="Contract.aspx?",u=$(r.list).map(function(n,t){return`<div class="span4 widget-container-span">
                                                <div class="widget-box light-border">
                                                    <div class="widget-header">
                                                        <h5 class="smaller">${t.DistinationNameEn}</h5>
                                                    </div>
                                                    <div class="widget-body">
                                                        <div class="widget-main padding-6">
                                                            <a id="cont${t.DistinationID}11" data-href="${i}cotype=1&catype=1&dist=${t.DistinationID}&cid=" href="javascript:;" class="btn btn-block btn-app btn-light btn-mini">عمولة ثابتة</a>
                                                            <a id="cont${t.DistinationID}21" data-href="${i}cotype=2&catype=1&dist=${t.DistinationID}&cid=" href="javascript:;" class="btn btn-block btn-app btn-light btn-mini">عمولة قائمة</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`}).get(),f=$(r.list).map(function(n,t){return`<div class="span4 widget-container-span">
                                                <div class="widget-box light-border">
                                                    <div class="widget-header">
                                                        <h5 class="smaller">${t.DistinationNameEn}</h5>
                                                    </div>
                                                    <div class="widget-body">
                                                        <div class="widget-main padding-6">
                                                            <a id="cont${t.DistinationID}12" data-href="${i}cotype=1&catype=2&dist=${t.DistinationID}&cid=" href="javascript:;" class="btn btn-block btn-app btn-light btn-mini">عمولة ثابتة</a>
                                                            <a id="cont${t.DistinationID}22" data-href="${i}cotype=2&catype=2&dist=${t.DistinationID}&cid=" href="javascript:;" class="btn btn-block btn-app btn-light btn-mini">عمولة قائمة</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`}).get();$(".full-Contracts").html(u);$(".part-Contracts").html(f);$.fn.wrapEvery=function(n,t){while(this.length)$(this.splice(0,n)).wrapAll(t)};$(".full-Contracts").wrapEvery(3,'<div class="row-fluid">');$(".part-Contracts").wrapEvery(3,'<div class="row-fluid">');t&&a(t)},u=$(".list-contracts .span4").length;u<=0?dataService.callAjax("Post",JSON.stringify({actionName:"Distinations_List"}),sUrl+"GetDataDirect",r,commonManger.errorException):t&&a(t)});f()},f=function(){$('[data-toggle="tooltip"],[data-rel=tooltip],.ace-tooltip').tooltip({delay:0}).on("hide.bs.tooltip",function(){$("div.tooltip").hide()});$(document).on("mouseleave",'[data-toggle="tooltip"],[data-rel=tooltip],.ace-tooltip',function(){$(this).tooltip("hide");$(".tooltip.fade.in").remove()})},l=function(){$("#contracts div.header-color-pink").removeClass("header-color-pink");$("#contracts a[id].btn-danger").removeClass("btn-danger").addClass("btn-light").attr("href","javascript:;");$("#contracts a[id].disabled").removeClass("disabled").attr("href","javascript:;")},nt=function(n,t){var r=commonManger.comp2json(n),u=r.list,f="Contract.aspx?",i=$("a[data-href]").map(function(n,t){return $(t).attr("data-href")}).get(),e=function(){$(u).each(function(n,t){var r="cont"+t.DistinationID+t.CommTypeID+t.ShippingCalcID,i=$("#"+r);i&&(i.attr("href",f+"id="+t.ClientCommID),i.removeClass("btn-light").addClass("btn-danger"),i.closest("div.widget-box").find("div.widget-header").addClass("header-color-pink"),i.closest("div").find("a:not([id="+r+"])").attr("href","javascript:;").addClass("disabled"))})};$("#contracts .modal-body a[id]").each(function(){var n=$(this),r=n.attr("data-href");n.attr("href",i[i.indexOf(r)]+t).removeClass("disabled");l()}).promise().done(function(){e()})},a=function(n){var t={actionName:"ClientCommissons_SelectRow",value:n};dataService.callAjax("Post",JSON.stringify(t),sUrl+"GetData",function(t){nt(t.d,n)},commonManger.errorException)},tt=function(){$.ajax({type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:"Clients.aspx/GetUsername",data:"{ }",success:function(n){$("#txtUsername,#txtPassword").val(n.d)},beforeSend:function(){$(".sinpper").html("<i class='icon-spinner icon-spin orange bigger-125'><\/i>")},complete:function(){$(".sinpper").html("")},error:function(){commonManger.showMessage("خطأ فى انشاء اسم المستخدم!","لم يتم العثور على اسم مستخدم لهذا العميل.")}})},v=function(n,t){n.Status&&($("#ClientModal").modal("hide"),r(),commonManger.showMessage("تمت عملية الإضافه بنجاح.",n.Message),t.ClientID=="0")},it=function(n){n=n.d;n.Status?(commonManger.showMessage("تمت العملية بنجاح.",n.message),r()):commonManger.showMessage("لم يتم الحذف.",n.Message)},y=function(){var n=!1;return $("#txtName").val()!==""&&$("#txtUsername").val()!==""&&$("#txtPassword").val()!==""&&(n=!0),n},et=function(){var n=$("#"+t+" tbody td input[type=checkbox]:checked");$(".sms-adding a.btnArchiveList").remove();n.length>0&&$(".sms-adding").append('<a href="javascript:void(0)" onclick="pageManager.archiveExpenses();" class="btn btn-info btn-mini btnArchiveList">ارسل رسالة<\/a>')},u=null,rt=function(){var r=$("#"+t).DataTable({sDom:"<'row-fluid'<'span6'l><'span6 lft-pane'BTf>r>t<'row-fluid'<'span6'i><'span6'p>>",buttons:[{extend:"csv",text:"تصدير إكسيل"},{text:"طباعة",action:function(){$(".dataTables_length,.form-horizontal").closest("div.row-fluid").addClass("hidden-print");window.print()}}],processing:!0,bServerSide:!0,responsive:!0,bDestroy:!0,language:{search:"_INPUT_",searchPlaceholder:"باسم العميل - رقم الجوال",processing:"<div class='widget-box-overlay'><i class='ace-icon fa fa-spinner fa-spin orange bigger-125'><\/i><\/div>"},sAjaxSource:"Clients.aspx/LoadData",iDisplayLength:25,order:[[0,"asc"]],fnServerParams:function(t){t.push({name:"type",value:i});e!==""&&t.push({name:"client",value:e});n!==undefined&&n!==null&&t.push({name:"client_char",value:n})},fnServerData:function(n,t,i){u&&u!==null&&u.abort();u=dataService.callAjax("GET",t,n,function(n){commonManger.setData2Grid(n,t.sEcho,i);f()},commonManger.errorException)},stateSaveCallback:function(n,t){localStorage.setItem("DTC_"+n.sInstance,JSON.stringify(t))},stateLoadCallback:function(n){return JSON.parse(localStorage.getItem("DTC_"+n.sInstance))},fnFooterCallback:function(n,t){for(var f,r=0,u=0,i=0;i<t.length;i++)f=parseFloat(t[i].BalanceDebit)-parseFloat(t[i].BalanceCredit)-t[i].PresentRequired*1,r+=f,u+=parseFloat(t[i].BalanceDebit*1-t[i].BalanceCredit*1+(t[i].SubDebit*1-t[i].SubCredit*1)-t[i].TotalRequired*1-t[i].SubTotal*1);$(".netTotal").text(numeral(r).format("0,0"));$(".all-required").html(numeral(u).format("0,0"))},createdRow:function(n,t){t.MasterID&&$(n).addClass("detail-row")},aoColumns:[{bSortable:!0,mData:function(n){var t="";return n.user_type==="1"&&(t='<span class="badge badge-yellow" data-rel="tooltip" title="عميل دائم/عقد"><i class="icon-asterisk"><\/i><\/span>'+(n.MasterAs&&n.MasterAs>0?'<div class="action-buttons pull-left"><a data-cid="'+n.ClientID+'" data-rel="tooltip" title="حسابات فرعية" href="javascript:void(0);" class="blue bigger-150 show-details-btn"><i class="ace-icon icon-chevron-down"><\/i><\/a><\/div>':"")),'<a data-rel="tooltip" href="ClientCars.aspx?id='+n.ClientID+'" title="سيارات العميل">'+n.full_name+"<\/a> "+t}},{mDataProp:"phone",bSortable:!1,sClass:"hidden-480"},{mDataProp:"user_name",bSortable:!1,sClass:"hidden-480"},{mDataProp:"BalanceDebit",bSortable:!1,mData:function(n){return numeral(parseFloat(n.BalanceDebit)-parseFloat(n.BalanceCredit)).format("0,0")}},{mData:"PresentRequired",bSortable:!1,mData:function(n){return numeral(n.PresentRequired).format("0,0")}},{bSortable:!1,mData:function(n){var t=parseFloat(n.BalanceDebit?n.BalanceDebit*1:0)-parseFloat(n.BalanceCredit?n.BalanceCredit*1:0)-n.PresentRequired*1;return numeral(t).format("0,0")}},{bSortable:!1,sClass:"hidden-480",mData:function(n){return'<span data-rel="tooltip" title="رصيد: '+numeral(n.BalanceDebit*1-n.BalanceCredit*1).format("0,0")+" - مطلوب:"+numeral(n.TotalRequired).format("0,0")+'">'+numeral(n.BalanceDebit*1-n.BalanceCredit*1-n.TotalRequired*1).format("0,0")+"<\/span>"}},{sClass:"hidden-print",bSortable:!1,mData:function(n){var t="";return n.user_type==="1"&&(t='<li><a href="clientbuyers.aspx?client='+n.ClientID+'" title="تحديد الباير">تحديد الباير<\/a><\/li>                                             <li><a data-cid="'+n.ClientID+'" class="click contr" data-toggle="modal" data-target="#contracts" href="#contracts" title="عقود البيع">عقود البيع<\/a><\/li>'),'<div class="btn-group"><button data-toggle="dropdown" class="btn btn-small btn-info dropdown-toggle">اخـتـر <i class="icon-angle-down icon-on-right"><\/i><\/button>                                    <ul class="dropdown-menu pull-right">                                        <li>                                            <a href="ClientCars.aspx?id='+n.ClientID+'">سيارات العميل<\/a>                                        <\/li>                                        <li>                                            <a data-cid="'+n.ClientID+'" class="edit click" data-toggle="modal" data-target="#ClientModal" href="#ClientModal">تعديل بيانات العميل<\/a>                                        <\/li>                                        <li>                                            <a class="sms click" data-toggle="modal" data-target="#addSMS" href="#addSMS" title="ارسل بيانات الدخول في رسالة للجوال">ارسل رسالة جوال<\/a>                                        <\/li>'+t+"<\/div>"}}]})},ot=function(n){var t={message:"تم إنشاء حسابك باسم: "+n.user_name+" كلمة سر: "+n.user_password+" www.iraqusedcars.ae",phones:((n.phone!=""&&n.countryCode!=""?n.countryCode+n.phone+",":"")+(n.phone2!=""&&n.countryCode2!=""?n.countryCode2+n.phone2:"")).replace(/,(\s+)?$/,"")},i=[t.phones+"|"+t.message+"|"+n.full_name],r={messages:i};dataService.callAjax("Post",JSON.stringify(r),"sms-templates.aspx/BulkSMS",ut,commonManger.errorException)},ut=function(n){var t,i,r;for(n=n.d,t="",i=0;i<n.length;i++)r=n[i].split("|"),t+=r[0].indexOf("Successful")>0?"<p>تم ارسال بيانات الدخول لجوال العميل: "+r[1]+"<\/p>":"<p>لم ترسل رسالة لجوال العميل: "+r[1]+"<\/p>";t!=""&&commonManger.showMessage("تم حفظ بيانات العميل بنجاح:",t)};return{Init:p,applyValidation:y,successCallback:v}}();