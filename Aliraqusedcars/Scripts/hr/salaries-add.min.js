formName="formMain";modalDialog="addModal";tableName="SalariesTotal";pKey="ID";gridId="listItems";gridColumns=[];TitlePage="راتب لموظف";var _id=commonManger.getQueryStrs().id,$userID=$("#UserID"),$month=$("#Month"),$year=$("#Year"),showEmps=function(n){var i=commonManger.comp2json(n.d),t=i.list;t!==undefined&&($(t).each(function(){$userID.append($("<option />").val(this.UserID).text(this.UserFullName))}),$userID.trigger("chosen:updated"))},oTable=$("#"+gridId).DataTable({sDom:"<'row'>t<'row'>",searching:!1,retrieve:!0,paging:!1,destroy:!0,aoColumnDefs:[{bVisible:!1,aTargets:[0,2,3,4,5,6,7,8,9,10,11,13]}]}),getDefaults=function(){var n=new moment,r=n.format("M"),u=n.format("YYYY"),t,i;$month.val(r);$year.val(u);t=JSON.stringify({actionName:"Salaries_Properties"});i=sUrl+"GetDataDirect";dataService.callAjax("Post",t,i,showEmps,commonManger.errorException)},getGridHeader=function(){return $("#"+formName).find("input[id],select[id],textarea[id]").map(function(){return this.id}).get()},fillDataTable=function(){var r=0,n=[],i=getGridHeader(),u=$("#UserID").val(),t,f,e;for($("#"+gridId+" tbody tr").find("td:nth-child(1)").each(function(){$(this).text()===$("#"+i[1]+" option:selected").text()&&(r=1)}),t=0;t<i.length;t++)f=$("#"+i[t]).prop("type"),f==="select-one"?(n.push($("#"+i[t]+" option:selected").text()),n.push($("#"+i[t]).val())):i[t].indexOf("otal")>0?n.push(numeral($("#"+i[t]).val()).format("0,0.00")):n.push($("#"+formName+" #"+i[t]).val());r!==1?(n.push('<button data-id="'+u+'" class="btn btn-minier btn-info edit" data-rel="tooltip" title="تعديل"><i class="icon-edit"><\/i><\/button> <button class="btn btn-minier btn-danger remove" data-rel="tooltip" title="حــذف"><i class="icon-remove"><\/i><\/button>'),oTable.row.add(n).draw(!1)):(e={_trIndex:$("button[data-id="+u+"]").closest("tr"),salValue:numeral($("#Total").val()).format("0,0.00")},$(n).each(function(t){t>2&&oTable.cell(e._trIndex,t).data(n[t]).draw()}));n=[];setSalariesTotal();$("#"+modalDialog).modal("hide");commonManger.showMessage("تم الاضافة بنجاح:","تمت عملية الاضافة بنجاح.")},setSalariesTotal=function(){var n=$("#Commission").val()*1,t=n*.05;$("#VAT").val(t);$("#"+gridId+" tbody tr").find("td:nth-child(2)").each(function(){n+=numeral().unformat($(this).text())});$("#TotalAmount").val(numeral(n).format("0,0.00"));n>100?$("#SaveAll").removeClass("hidden"):$("#SaveAll").addClass("hidden")},resetSalaryForm=function(){$("#UserID").val("").trigger("chosen:updated");$("#"+formName+" input[id]").val(0);$("#"+formName+" textarea").val("");$("#"+formName+" #RepayAmount").attr("data-val",0)},sumSalaryTotal=function(){var n=0;$("input[name$=plus]").each(function(){n+=numeral().unformat($(this).val())});$("input[name$=minus]").each(function(){n-=numeral().unformat($(this).val())});$("#Total").val(n)},showEmpDefaults=function(n){var i=commonManger.comp2json(n.d),t=i.list;t!==undefined?($("#DefaultSalary").val(numeral(t.DefaultSalary).format("0.00")),$("#Housing").val(numeral(t.Housing).format("0.00")),$("#Other").val(numeral(t.Other).format("0.00")),$("#Perks").val(numeral(t.Perks).format("0.00")),$("#SalaryIncrease").val(numeral(t.SalaryIncrease).format("0.00")),$("#Travel").val(numeral(t.Travel).format("0.00")),$("#RepayAmount,.advBalance").attr("title","رصيد السلف على الموظف: "+numeral(t.AdvancesBalance).format("0,0.00")+" درهم").attr("data-original-title","رصيد السلف على الموظف: "+numeral(t.AdvancesBalance).format("0,0.00")+" درهم").attr("data-val",t.AdvancesBalance),sumSalaryTotal()):$("#"+formName).find("textarea,input[id]").val(0)},successSave=function(n){n=n.d;n.Status?window.location.href="hr/salaries.aspx":commonManger.showMessage("خطأ بالحفظ","برجاء التحقق من الرواتب والمحاولة مرة أخرى."+n.message)},bindDataGrid=function(n){$(n).each(function(n,t){oTable.row.add(t).draw(!1)})},bindmyData=function(n){var i=commonManger.comp2json(n.d),t=i.list,r=i.list1;r&&($(r).each(function(n,i){var r=[];r.push(i.ID,i.UserFullName,i.UserID,i.DefaultSalary,i.SalaryIncrease,i.Housing,i.Travel,i.Perks,i.Other,i.Deduct,i.RepayAmount,i.AdvanceAmount,numeral(i.Total).format("0,0.00"),i.Notes,t.Revised==="false"?'<button data-id="'+i.UserID+'" class="btn btn-minier btn-info edit" data-rel="tooltip" title="تعديل"><i class="icon-edit"><\/i><\/button> <button class="btn btn-minier btn-danger remove" data-rel="tooltip" title="حــذف"><i class="icon-remove"><\/i><\/button>':"---");oTable.row.add(r).draw(!1)}),setSalariesTotal());t&&($("#masterForm #ID").val(t.ID),$("#AddDate").val(commonManger.formatJSONDateCal(t.AddDate)),$("#Year").val(t.Year),$("#Month").val(t.Month),t.Revised=="true"&&($("#Revised").prop("checked",!0),$("#SaveAll").addClass("hidden")))},getSalaryFile=function(){if(_id!==undefined&&_id>0){var n={actionName:"Salaries_GetDetails",value:_id};dataService.callAjax("Post",JSON.stringify(n),sUrl+"GetData",bindmyData,commonManger.errorException)}},applyValidation=function(){var n=!1,t=$("#RepayAmount"),i=parseFloat(t.attr("data-val")),r=parseFloat(t.val().replace(",",""));return r<=i&&(n=!0),n};$("#btnAddNew").click(function(n){n.preventDefault();resetSalaryForm();$("#addModal").modal("show");$("#addModal .modal-header h3").html('<i class="icon-plus"><\/i> اضافة راتب موظف')});$userID.change(function(){var n=$(this).val(),t,i;n>0?(t=JSON.stringify({actionName:"Salaries_GetEmpDefaults",value:n}),i=sUrl+"GetData",dataService.callAjax("Post",t,i,showEmpDefaults,commonManger.errorException)):resetSalaryForm()});$("#"+formName+" input[type=number]").change(function(){sumSalaryTotal()});$("#"+modalDialog+" .modal-footer .btn-success").click(function(n){n.preventDefault();var t=applyValidation();$("#UserID").val()!==""?t?fillDataTable():commonManger.showMessage("التحقق من البيانات","مبلغ سداد السلفة يكون اقل أو يساوى رصيد السلف."):commonManger.showMessage("التحقق من البيانات","برجاء التحقق من اختيار الموظف.")});$("#"+gridId+" tbody").delegate("tr button","click",function(n){var t,i,r;n.preventDefault();t=$(this);i=t.closest("tr").index();i!==null&&(t.hasClass("remove")?DeleteConfirmation(function(){oTable.row(t.closest("tr")).remove().draw();setSalariesTotal()}):t.hasClass("edit")&&(commonManger.ResetControls(formName),$("input[name=minus]").val(0),r=$(this).attr("data-id"),$("#"+modalDialog).modal("show"),$("#UserID").val(r).trigger("chosen:updated").change()))});$("#SaveAll").click(function(n){n.preventDefault();var i=getGridHeader(),t=[];oTable.rows().every(function(){var n=$.map(this.data(),function(n,t){if(t!==1&&t!==14)return n.replace(/,/g,"")}).join(",");t.push(n)});commonManger.SaveDataMasterDetails("","masterForm",successSave,"",i,t,"SalariesTotal_Save","1")});$("#Commission").blur(function(){setSalariesTotal()});$('input[type="text"]').on("focus click",function(){$(this).select()});getDefaults();getSalaryFile();