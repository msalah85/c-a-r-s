var partsManager=function(){var n={billBody:$("#listItems tbody"),billFooter:$("#listItems tfoot"),TotalAmount:$("#TotalAmount"),Discount:$('input[name="Discount"]'),NetAmount:$("#NetAmount"),newLine:$(".newLine"),rowClone:'<tr><td class="itemdiv center"><span class="num">1<\/span><input type="hidden" name="childID" value="0" /><div class="tools"><a href="#delete" class="btn btn-minier btn-danger"><i class="icon-only icon-trash"><\/i><\/a><\/div><\/td><td class="edit"><input name="PartName" required class="input-block-level form-control new" type="text"><\/td><td class="edit"><input name="Quantity" required class="input-block-level form-control number new" type="number" value="0"><\/td><td class="edit"><input name="Price" required class="input-block-level form-control money new" type="text" value="0"><\/td><td>0<\/td><\/tr>',saveAll:$("#SaveAll"),invoiceID:$("#ID"),clintId:$("#ClientID"),invoiceN:$("#InvoiceNo"),cName:$("#txtName"),cSave:$("#btnSave"),countryCode:$("#countryCode"),phone:$("#txtPhone")},t=function(){for(var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<5;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},u=function(){var t={actionName:"PartsInvoices_SelectOne",value:n.invoiceID.val()};dataService.callAjax("Post",JSON.stringify(t),sUrl+"GetData",function(t){var u=commonManger.comp2json(t.d),i=u.list,f=u.list1;i&&($("#Discount").val(numeral(i.Discount).format("0,0.00")),$("#InvoiceNo").val(i.InvoiceNo),$("#AddDate").val(moment(i.AddDate).format("dd/MM/yyyy")),$("#Notes").val(i.Notes),$('[name="Discount"]').val(numeral(i.Discount).format("0,0.00")),ClientsListManager.SearchClientsList(i.full_name),$.fn.afterLoadClients=function(){$("#ClientID").val(i.ClientID)});f&&(n.billBody.empty(),$(f).each(function(t,i){var r=$(n.rowClone).clone(!0);$(".num",r).text(t+1);$("[name='childID']",r).val(i.ID);$("[name='PartName']",r).val(i.PartName);$("[name='Quantity']",r).val(i.Quantity);$("[name='Price']",r).val(numeral(i.Price).format("0,0.00"));$("td:eq(4)",r).text(numeral(i.SubTotal).format("0,0.00"));n.billBody.append($(r))}).promise().done(function(){r()}))},commonManger.errorException)},f=function(){var f=commonManger.getQueryStrs().id;f&&(n.invoiceID.val(f),u());$(".money").autoNumeric("init");n.billBody.sortable({opacity:.8,revert:!0,forceHelperSize:!0,placeholder:"draggable-placeholder",forcePlaceholderSize:!0,tolerance:"pointer",stop:function(n,t){$(t.item).css("z-index","auto")}});n.billBody.delegate('input[name="Quantity"],input[name="Price"]',"keyup",function(){var n=$(this).closest("tr"),t=numeral().unformat(n.find('input[name="Quantity"]').val())*numeral().unformat(n.find('input[name="Price"]').val());n.find("td:eq(4)").text(numeral(t).format("0,0.00"));r()});n.billFooter.delegate(n.Discount,"keyup",function(){i()});n.billBody.delegate("tr td.itemdiv a","click",function(n){n.preventDefault();var t=$(this).closest("tr");s(t)});n.newLine.on("click",function(t){var i,r;t.preventDefault();i=n.rowClone.replace("1",n.billBody.children("tr").length+1);n.billBody.append($(i));$("input.new").each(function(){$(this).rules("add",{required:!0})});n.billBody.find('input[name="PartName"]:last').focus();$(".money").autoNumeric("init");r=commonManger.applyValidation("aspnetForm");r||commonManger.showMessage("حقول مطلوبة","برجاء التأكد من ادخال جميع الحقول فى الفاتورة.")});n.saveAll.on("click",function(t){var i,r,u;t.preventDefault();i=[];r=[n.invoiceID.val(),n.clintId.val(),n.invoiceN.val(),commonManger.dateFormat($("#AddDate").val()),$("#Notes").val(),numeral().unformat(n.TotalAmount.text()),numeral().unformat(n.Discount.val()),numeral().unformat(n.NetAmount.text())];n.billBody.children("tr").each(function(t,r){var u={id:$(r).find("input:eq(0)").val(),invoiceId:n.invoiceID.val(),title:$(r).find("input:eq(1)").val().replace("~"," "),quan:numeral().unformat($(r).find("input:eq(2)").val()),price:numeral().unformat($(r).find("input:eq(3)").val()),total:numeral().unformat($(r).find("td:last").text())},f;u.title!==""&&u.total>0&&(f=u.id+"~"+u.invoiceId+"~"+u.title+"~"+u.quan+"~"+u.price+"~"+u.total,i.push(f))});i.length>0&&n.clintId.val()>0&&n.invoiceN.val()!==""?(u={masterValues:r,detailsValues:i},dataService.callAjax("Post",JSON.stringify(u),"partsadd.aspx/SaveDataMasterDetails",function(n){commonManger.showMessage("تم الحفظ بنجاح:",n.d.message);n.d.ID>0&&(document.location.href="PartsPrint.aspx?id="+n.d.ID)},commonManger.errorException)):commonManger.showMessage("لا توجد قطع غيار فى الفاتورة:","برجاء ادخال قطع الغيار فى الفاتورة أولاً.")});n.billBody.delegate('input[name="Price"]:last',"blur",function(){n.newLine.trigger("click")});n.cSave.click(function(i){i.preventDefault();var r={ClientID:0,full_name:n.cName.val(),phone:n.phone.val(),countryCode:n.countryCode.val(),user_name:t(),user_password:t(),user_type:2,send_sms:!1},u={scParam:r};n.cName.val()!==""&&commonManger.doWork("ClientModal","formMain","Clients.aspx/SaveClient",u,e,commonManger.errorException)})},e=function(t){t=t.d;commonManger.showMessage("تمت عملية الإضافه بنجاح.",t.Message);t.Status&&($("#ClientModal").modal("hide"),n.clintId.append($("<option/>").text(n.cName.val()).val(t.Id)),n.clintId.val(t.Id),n.clintId.trigger("chosen:updated"))},o=function(){n.billBody.find("tr").each(function(n){$(this).find("span.num").text(n+1)})},s=function(n){n.css({transition:"background-color 1s","background-color":"red"}).fadeOut("slow").promise().done(function(){n.remove();o()})},i=function(){var t=numeral().unformat(n.TotalAmount.text())-numeral().unformat(n.Discount.val());n.NetAmount.text(numeral(t).format("0,0.00"))},r=function(){var t=0;n.billBody.children("tr").each(function(){t+=numeral().unformat($(this).find("td:eq(4)").text())}).promise().done(function(){n.TotalAmount.text(numeral(t).format("0,0.00"));i()})};return{Init:f}}();partsManager.Init();